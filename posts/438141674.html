<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="description" content="js中关于base64的一些事"><meta name="keywords" content="js,base64,blob"><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><title>js中关于base64的一些事 - zWing</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6650629ba7ddbfe98e2f63700c2e6923";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><div class="indicator"></div><canvas id="ribbon"></canvas><main class="main"><header class="header"><a class="logo" href="/">zWing</a><nav class="menu"><a href="/archives/">Archives</a><a href="/tags/">Tags</a><a href="/about/">About</a><a href="/repo/">Repo</a></nav><div class="social"><a target="_blank" href="/rss.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18,15.64A2.18,2.18 0 0,1 8.36,17.82C8.36,19 7.38,20 6.18,20C5,20 4,19 4,17.82A2.18,2.18 0 0,1 6.18,15.64M4,4.44A15.56,15.56 0 0,1 19.56,20H16.73A12.73,12.73 0 0,0 4,7.27V4.44M4,10.1A9.9,9.9 0 0,1 13.9,20H11.07A7.07,7.07 0 0,0 4,12.93V10.1Z"></path></svg> </a><a target="_blank" href="https://github.com/zWingz/my-blog-config/issues"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"></path></svg></a></div></header><div class="content-container center"><div id="post" class="flex"><aside class="toc"><div class="stay"><ul><li><a href="#%E4%BB%8B%E7%BB%8D">介绍</a></li><li><a href="#%E7%BC%96%E7%A0%81%E5%92%8C%E8%A7%A3%E7%A0%81">编码和解码</a><ul><li><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8">浏览器</a></li><li><a href="#node">Node</a></li></ul></li><li><a href="#%E8%BD%AC%E6%8D%A2%E6%96%B9%E5%BC%8F">转换方式</a><ul><li><a href="#%E7%BC%96%E7%A0%81">编码</a></li><li><a href="#%E8%A7%A3%E7%A0%81">解码</a></li></ul></li><li><a href="#%E9%A2%98%E5%A4%96-%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2">题外-进制转换</a></li><li><a href="#%E5%8F%82%E8%80%83">参考</a></li></ul><span class="toc-icon"></span></div></aside><article class="post-content"><time class="time">April 29, 2019</time><h1 class="title">js中关于base64的一些事</h1><div><a href="/tags/819211023" class="tags-item" style="background: #c5def5;">Js</a></div><div class="content"><h3 id="介绍" class="heading"><a href="#%E4%BB%8B%E7%BB%8D" aria-hidden="true"><span class="icon icon-link"></span></a>介绍</h3><p><code class="language-text">base64</code>其实是一种编码转换方式, 将<code class="language-text">ASCII</code>字符转换成普通文本, 是网络上最常见的用于传输8Bit字节代码的编码方式之一。</p><p><code class="language-text">base64</code>由字母<code class="language-text">a-z</code>、<code class="language-text">A-Z</code>、<code class="language-text">0-9</code>以及<code class="language-text">+</code>和<code class="language-text">/</code>, 再加上作为垫字的<code class="language-text">=</code>, 一共65字符组成一个基本字符集, 其他所有字符都可以根据一定规则, 转换成该字符集中的字符。</p><blockquote><p><code class="language-text">abcde</code> => <code class="language-text">YWJjZGU=</code> <code class="language-text">ABCDE</code> => <code class="language-text">QUJDREU=</code></p></blockquote><p>在日常开发中, 最常见的便是将<code class="language-text">blob</code>和<code class="language-text">base64</code>之间相互转换.</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// blob to base64</span>
<span class="token keyword">function</span> <span class="token function">blobTobase64</span><span class="token punctuation">(</span><span class="token parameter">blob</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fileReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> base64 <span class="token operator">=</span> <span class="token string">''</span>
  fileReader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    base64 <span class="token operator">=</span> fileReader<span class="token punctuation">.</span>result <span class="token comment">// 读取base64</span>
  <span class="token punctuation">}</span>
  fileReader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span> <span class="token comment">// 读取blob</span>
<span class="token punctuation">}</span>
<span class="token comment">// base64 to blob</span>
<span class="token keyword">function</span> <span class="token function">dataURItoBlob</span><span class="token punctuation">(</span><span class="token parameter">dataURI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> mimeString <span class="token operator">=</span> dataURI
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// mime类型</span>
  <span class="token keyword">var</span> byteString <span class="token operator">=</span> <span class="token function">atob</span><span class="token punctuation">(</span>dataURI<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//base64 解码</span>
  <span class="token keyword">var</span> arrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>byteString<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">//创建ArrayBuffer</span>
  <span class="token keyword">var</span> intArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span> <span class="token comment">//创建视图</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> byteString<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    intArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> byteString<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>intArray<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> mimeString <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 转成 blob</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="编码和解码" class="heading"><a href="#%E7%BC%96%E7%A0%81%E5%92%8C%E8%A7%A3%E7%A0%81" aria-hidden="true"><span class="icon icon-link"></span></a>编码和解码</h3><h4 id="浏览器" class="heading"><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8" aria-hidden="true"><span class="icon icon-link"></span></a>浏览器</h4><p>最新的浏览器自带了两个方法用于<code class="language-text">base64</code>的编码和解码</p><p>分别是<code class="language-text">atob</code>和<code class="language-text">btoa</code></p><ul><li>atob：将<code class="language-text">base64</code>转成<code class="language-text">8bit</code>字节码</li><li>btoa：将<code class="language-text">8bit</code>字节码转成<code class="language-text">base64</code></li></ul><p>对于旧版浏览器, 可以使用<a href="https://github.com/dankogai/js-base64">js-base64</a></p><h4 id="node" class="heading"><a href="#node" aria-hidden="true"><span class="icon icon-link"></span></a>Node</h4><p>目前<code class="language-text">node</code>中还不支持使用<code class="language-text">atob</code>和<code class="language-text">btoa</code>，但是可以通过<code class="language-text">Buffer</code>来实现, <a href="http://nodejs.cn/api/buffer.html#buffer_class_method_buffer_from_array">参考文档</a></p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> btoa <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  global<span class="token punctuation">.</span><span class="token function-variable function">btoa</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> atob <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  global<span class="token punctuation">.</span><span class="token function-variable function">atob</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">b64Encoded</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Buffer<span class="token punctuation">.</span><span class="token function">frome</span><span class="token punctuation">(</span>b64Encoded<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="转换方式" class="heading"><a href="#%E8%BD%AC%E6%8D%A2%E6%96%B9%E5%BC%8F" aria-hidden="true"><span class="icon icon-link"></span></a>转换方式</h3><blockquote><p>base64编码方式对于中文是不适用的, 因为中文对应多个字节, 因此可以先使用<code class="language-text">encodeURIComponent</code>编码后再进行<code class="language-text">base64</code>编码.</p></blockquote><p><a href="https://github.com/zWingz/base64">源码</a></p><h4 id="编码" class="heading"><a href="#%E7%BC%96%E7%A0%81" aria-hidden="true"><span class="icon icon-link"></span></a>编码</h4><ol><li><p>每三个字节作为一组，每个字节8bit, 一共是24个二进制位。</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token string">'ABCD'</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'ABC'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'01000001010000100100001'</span><span class="token punctuation">,</span> <span class="token string">'01000100'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// 每三字节做一组 // 转成8bit</span>
</code></pre></div></li><li><p>将每组的24个二进制位再细分为四组，每组有6个二进制位, 此时为二维数组。</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">;</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'010000'</span><span class="token punctuation">,</span> <span class="token string">'010100'</span><span class="token punctuation">,</span> <span class="token string">'001001'</span><span class="token punctuation">,</span> <span class="token string">'000011'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'010001'</span><span class="token punctuation">,</span> <span class="token string">'00'</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre></div><ul><li>二个字节的情况：将这二个字节的一共16个二进制位, 按照上面的规则, 转成三组, 那么最后一项只有4位，则在后面加两个0, 补够6位, 并在第三步对应位置加上垫字符<code class="language-text">=</code>。</li><li>一个字节的情况：将这一个字节的8个二进制位，按照上面的规则转成二组, 那么最后一项只有2位, 则在后面加上四个0, 并在第三步对应位置加上两个垫字符<code class="language-text">=</code>。</li><li>简单说就是, 缺多少位就在后面补多少个0, 直到满6位。<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">;</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'010000'</span><span class="token punctuation">,</span> <span class="token string">'010100'</span><span class="token punctuation">,</span> <span class="token string">'001001'</span><span class="token punctuation">,</span> <span class="token string">'000011'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'010001'</span><span class="token punctuation">,</span> <span class="token string">'000000'</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre></div></li></ul></li><li><p>在每组前面加两个00，扩展成32个二进制位，即四个字节。</p><blockquote><p>规则是这么说, 但这一步我觉得可以忽略, 因为<code class="language-text">00101010</code>和<code class="language-text">101010</code> 是一样的</p></blockquote></li><li><p>将每组对应的二进制转成十进制, 在<code class="language-text">base64char</code>字符集中找到对应的字符。</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">;</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'Q'</span><span class="token punctuation">,</span> <span class="token string">'U'</span><span class="token punctuation">,</span> <span class="token string">'J'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'R'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre></div><ul><li><p>每一组都最终都应该转成四个字符</p></li><li><p>如果不足四个字符, 说明明文中并不足3字节, 因此需要补上垫字符<code class="language-text">=</code>, 补够四个字符</p></li></ul><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">;</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'Q'</span><span class="token punctuation">,</span> <span class="token string">'U'</span><span class="token punctuation">,</span> <span class="token string">'J'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'R'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre></div></li><li><p>将最后的结果连接成字符串, 则为最终编码结果。</p><blockquote><p>'ABCD' > 'QUJDRA=='</p></blockquote></li></ol><p>根据编码方式来看, 每3个字节将会被编码成四个字符, 如果不足3个字节, 则补上垫字符<code class="language-text">=</code>, 缺几个就补几个。</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">btoa</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token comment">// "QQ=="</span>
<span class="token function">btoa</span><span class="token punctuation">(</span><span class="token string">'AB'</span><span class="token punctuation">)</span> <span class="token comment">// "QUI="</span>
<span class="token function">btoa</span><span class="token punctuation">(</span><span class="token string">'ABC'</span><span class="token punctuation">)</span> <span class="token comment">// "QUJD"</span>
<span class="token function">btoa</span><span class="token punctuation">(</span><span class="token string">'ABCD'</span><span class="token punctuation">)</span> <span class="token comment">// "QUJDRA=="</span>
</code></pre></div><h4 id="解码" class="heading"><a href="#%E8%A7%A3%E7%A0%81" aria-hidden="true"><span class="icon icon-link"></span></a>解码</h4><p>解码步骤就是跟编码步骤反过来</p><ol><li>每四个字节分为一组。</li><li>将每组的中除了垫字符<code class="language-text">=</code>外的字符, 在<code class="language-text">base64char</code>字符集中找到所在下标。</li><li>将十进制下标转成二进制, 如果不够6位（一定不会超过6位）, 则在前面补<code class="language-text">0</code>。<ol><li>如果遇到垫字符<code class="language-text">=</code>, 说明其明文不足3字节, 则根据垫字符<code class="language-text">=</code>的数量, 在该组最后一项中去掉对应个数的<code class="language-text">0</code></li><li>一个垫字符, 则去掉两个<code class="language-text">0</code></li><li>两个垫字符, 则去掉四个<code class="language-text">0</code></li></ol></li><li>将每组中的二进制字符串连接，此时字符串长度一定是8的倍数，然后每8位分割成一个字节。</li><li>通过<code class="language-text">String.fromCharCode</code>将二进制转成字符, 然后拼接</li><li>将各个字符连接, 为最终解码结果。</li></ol><h3 id="题外-进制转换" class="heading"><a href="#%E9%A2%98%E5%A4%96-%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2" aria-hidden="true"><span class="icon icon-link"></span></a>题外-进制转换</h3><ul><li>parseInt(str, radix): 根据radix可以将字符串转成十进制</li><li>initValue.toString(radix): 将initValue转成其他进制</li></ul><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// n进制转十进制</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'1000'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span>
  <span class="token string">'1000'</span><span class="token punctuation">,</span>
  <span class="token number">16</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>
  <span class="token comment">// 4096</span>

  <span class="token comment">// 进制间转换</span>
  <span class="token number">10</span>
<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
    <span class="token comment">// "1010", 10进制转2进制</span>
    <span class="token number">0xff</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// "11111111", 16进制转2进制</span>
</code></pre></div><h3 id="参考" class="heading"><a href="#%E5%8F%82%E8%80%83" aria-hidden="true"><span class="icon icon-link"></span></a>参考</h3><p><a href="https://www.zhangxinxu.com/wordpress/2018/08/js-base64-atob-btoa-encode-decode/">原来浏览器原生支持JS Base64编码解码</a> <a href="http://www.ruanyifeng.com/blog/2008/06/base64.html">Base64笔记</a></p></div><div class="comments"><div id="gitalk-container"></div></div></article></div></div></main><footer class="footer"><div class="center">Powered by <a target="_blank" href="https://github.com/acyortjs/acyort">AcyOrt</a> / Theme <a target="_blank" href="https://github.com/acyortjs/theme-donob">donob</a></div></footer><script src="/script/post.js"></script><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script>const gitalkConfig = JSON.parse('{"owner":"zWingz","repo":"my-blog-config","admin":["zWingz"],"clientID":"0438ed96c0cb944693a7","clientSecret":"23e7aa3152f5d03d8f20029540741d6f886c9f5b","number":33}')
  var gitalk = new Gitalk({
    ...gitalkConfig
  })
  gitalk.render('gitalk-container')</script><script defer="defer" src="/script/ribbon.js"></script></body></html>