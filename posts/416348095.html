<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="description" content="lerna与lerna-changelog使用介绍"><meta name="keywords" content=""><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><title>lerna与lerna-changelog使用介绍 - zWing</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6650629ba7ddbfe98e2f63700c2e6923";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><div class="indicator"></div><canvas id="ribbon"></canvas><main class="main"><header class="header"><a class="logo" href="/">zWing</a><nav class="menu"><a href="/archives/">Archives</a><a href="/tags/">Tags</a><a href="/about/">About</a><a href="/repo/">Repo</a></nav><div class="social"><a target="_blank" href="/rss.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18,15.64A2.18,2.18 0 0,1 8.36,17.82C8.36,19 7.38,20 6.18,20C5,20 4,19 4,17.82A2.18,2.18 0 0,1 6.18,15.64M4,4.44A15.56,15.56 0 0,1 19.56,20H16.73A12.73,12.73 0 0,0 4,7.27V4.44M4,10.1A9.9,9.9 0 0,1 13.9,20H11.07A7.07,7.07 0 0,0 4,12.93V10.1Z"></path></svg> </a><a target="_blank" href="https://github.com/zWingz/my-blog-config/issues"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"></path></svg></a></div></header><div class="content-container center"><div id="post" class="flex"><aside class="toc"><div class="stay"><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">基本使用</a><ul><li><a href="#install-%E5%AE%89%E8%A3%85">Install 安装</a></li><li><a href="#init-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE">Init 初始化项目</a></li><li><a href="#lernajson-%E9%85%8D%E7%BD%AE">Lerna.json 配置</a></li><li><a href="#create-%E5%88%9B%E5%BB%BA%E5%AD%90%E9%A1%B9%E7%9B%AE">Create 创建子项目</a></li><li><a href="#add-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96">Add 添加依赖</a></li><li><a href="#run-%E6%89%A7%E8%A1%8Cnpm-script%E5%91%BD%E4%BB%A4">Run 执行npm script命令</a></li><li><a href="#exec-%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4">Exec 执行任意命令</a></li><li><a href="#%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4">其他命令</a></li></ul></li><li><a href="#%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8">进阶使用</a><ul><li><a href="#lerna-changelog">Lerna-changelog</a><ul><li><a href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4">使用步骤</a></li><li><a href="#%E6%B3%A8%E6%84%8F">注意</a></li></ul></li><li><a href="#%E5%AD%90%E9%A1%B9%E7%9B%AE%E7%9A%84changelog">子项目的changelog</a></li></ul></li></ul><ul><li><a href="#%E7%BB%93%E8%AF%AD">结语</a></li></ul><span class="toc-icon"></span></div></aside><article class="post-content"><time class="time">March 02, 2019</time><h1 class="title">lerna与lerna-changelog使用介绍</h1><div><a href="/tags/819211154" class="tags-item" style="background: #92efc8;">Front End </a><a href="/tags/1260808058" class="tags-item" style="background: #b2ffb3;">工具介绍</a></div><div class="content"><p><a href="https://github.com/lerna/lerna">lerna</a>用于管理多<code class="language-text">package</code>，且各<code class="language-text">package</code>可能会互相引用的项目。</p><p><code class="language-text">lerna</code>通过两种方式管理子项目的版本号：</p><ul><li>Fixed/Locked mode (default)：每次执行<code class="language-text">lerna publish</code>都会将所涉及到的包升级到最新一个版本，开发者只需要确定发布下一个<code class="language-text">version</code>。</li><li>Independent mode：由开发者自行管理子项目的<code class="language-text">version</code>，每次执行<code class="language-text">lerna publish</code>都需要确定每个包的下个版本号。</li></ul><h3 id="基本使用" class="heading"><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8" aria-hidden="true"><span class="icon icon-link"></span></a>基本使用</h3><p>以下命令以<code class="language-text">yarn</code>为主。</p><h4 id="install-安装" class="heading"><a href="#install-%E5%AE%89%E8%A3%85" aria-hidden="true"><span class="icon icon-link"></span></a>Install 安装</h4><p><code class="language-text">yarn global add lerna</code></p><h4 id="init-初始化项目" class="heading"><a href="#init-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE" aria-hidden="true"><span class="icon icon-link"></span></a>Init 初始化项目</h4><p><code class="language-text">lerna init</code> 命令执行完毕后，会在生成对应的目录结构。</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">lerna-repo/
  package.json
  lerna.json
  packages/
    package-1/
      package.json
    package-2/
      package.json</code></pre></div><h4 id="lernajson-配置" class="heading"><a href="#lernajson-%E9%85%8D%E7%BD%AE" aria-hidden="true"><span class="icon icon-link"></span></a>Lerna.json 配置</h4><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token string">"version"</span><span class="token operator">:</span> <span class="token string">"1.1.3"</span><span class="token punctuation">,</span> <span class="token comment">// 项目版本</span>
  <span class="token string">"npmClient"</span><span class="token operator">:</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token comment">// 默认使用的npm，可改为yarn</span>
  <span class="token string">"command"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// lerna 内置命令的配置</span>
    <span class="token string">"publish"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"ignoreChanges"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"*.md"</span><span class="token punctuation">,</span> <span class="token string">"**/test/**"</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 发布时忽略部分文件的改动，配置此项可以减少不必要的publish。</span>
      <span class="token string">"message"</span><span class="token operator">:</span> <span class="token string">"chore(release): publish"</span> <span class="token comment">// git commit message</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"packages"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"packages/*"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div><h4 id="create-创建子项目" class="heading"><a href="#create-%E5%88%9B%E5%BB%BA%E5%AD%90%E9%A1%B9%E7%9B%AE" aria-hidden="true"><span class="icon icon-link"></span></a>Create 创建子项目</h4><p><code class="language-text">lerna create &lt;name&gt;</code> 创建一个子项目，并会根据交互提示生成对应的<code class="language-text">package.json</code></p><h4 id="add-添加依赖" class="heading"><a href="#add-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96" aria-hidden="true"><span class="icon icon-link"></span></a>Add 添加依赖</h4><p><code class="language-text">lerna add &lt;package&gt;[@version] [--dev] [--exact]</code></p><ul><li><code class="language-text">lerna add eslint</code>： 所有包都会装上<code class="language-text">eslint</code>。</li><li><code class="language-text">lerna add eslint --scope=package1</code>：只有<code class="language-text">package1</code>会装上。</li><li><code class="language-text">lerna add eslint packages/prefix-*</code>：符合<code class="language-text">prefix</code>的包会装上。</li></ul><p>options:</p><ul><li><code class="language-text">-dev</code>：添加到<code class="language-text">devDependencies</code></li><li><code class="language-text">--exact</code>: 只安装特定版本</li></ul><p>如果添加的是子项目，则会通过<code class="language-text">link</code>软连接到对应的项目中。 <code class="language-text">lerna add package1 --scope=package2</code></p><h4 id="run-执行npm-script命令" class="heading"><a href="#run-%E6%89%A7%E8%A1%8Cnpm-script%E5%91%BD%E4%BB%A4" aria-hidden="true"><span class="icon icon-link"></span></a>Run 执行npm script命令</h4><p><code class="language-text">lerna run &lt;script&gt; -- [..args]</code></p><ul><li><code class="language-text">lerna run test</code>：则会执行所有子项目中的<code class="language-text">test</code>。</li><li><code class="language-text">lerna run --scope package1 test</code>：只执行<code class="language-text">package1</code>中的<code class="language-text">test</code>。</li><li><code class="language-text">lerna run --ignore package-* test</code>：只执行除了匹配<code class="language-text">package-*</code>外的项目中的<code class="language-text">test</code></li></ul><h4 id="exec-执行任意命令" class="heading"><a href="#exec-%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4" aria-hidden="true"><span class="icon icon-link"></span></a>Exec 执行任意命令</h4><p><code class="language-text">lerna exec -- &lt;command&gt; [..args]</code></p><p>与<code class="language-text">lerna run</code>类似，只不过它可以执行任意命令。 eg: <code class="language-text">lerna exec -- rm -rf ./node_modules</code></p><h4 id="其他命令" class="heading"><a href="#%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4" aria-hidden="true"><span class="icon icon-link"></span></a>其他命令</h4><ul><li><code class="language-text">lerna bootstrap</code>：安装各子项目依赖，对相互引用的项目进行软连接，在子项目中执行<code class="language-text">npm run prepublish</code>和<code class="language-text">npm run prepare</code><ul><li><code class="language-text">--hoist [glob]</code>：会将子项目的匹配的依赖(eg：<code class="language-text">eslint</code>, <code class="language-text">jest</code>等)，统一放在根目录的<code class="language-text">node_modules</code>中，减少安装时间，但仅限<code class="language-text">npmClient=npm</code></li><li><code class="language-text">—nohoist [glob]</code>: 匹配的依赖(eg: <code class="language-text">babel</code>)会安装到子项目中的<code class="language-text">node_modules</code>中</li></ul></li><li><code class="language-text">lerna clean</code>：删除子项目的<code class="language-text">node_modules</code></li><li><code class="language-text">lerna link</code>：同<code class="language-text">bootstrap</code>第二步。</li></ul><h3 id="进阶使用" class="heading"><a href="#%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8" aria-hidden="true"><span class="icon icon-link"></span></a>进阶使用</h3><h4 id="lerna-changelog" class="heading"><a href="#lerna-changelog" aria-hidden="true"><span class="icon icon-link"></span></a>Lerna-changelog</h4><p><a href="https://github.com/lerna/lerna-changelog">lerna-changelog</a>基于<code class="language-text">pr</code>来为项目生成<code class="language-text">changelog</code></p><p>可参考<a href="https://github.com/zWingz/acyort-donob-plugins/issues?q=is%3Apr+is%3Aclosed">repo</a></p><h5 id="使用步骤" class="heading"><a href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4" aria-hidden="true"><span class="icon icon-link"></span></a>使用步骤</h5><ul><li>从<code class="language-text">master</code>分支切换出<code class="language-text">feature</code>/<code class="language-text">bugfix</code>等分支，参考<a href="https://github.com/nvie/gitflow">git-flow</a>。</li><li>完成开发后进行<code class="language-text">commit</code>，推荐使用<a href="https://github.com/commitizen/cz-cli">commitizen</a>来规范<code class="language-text">commit msg</code>，同时有助于对后续子项目生成<code class="language-text">changelog</code>。</li><li>将新分支<code class="language-text">push</code>到<code class="language-text">remote</code>端。</li><li>创建<code class="language-text">pr</code>，并打上<code class="language-text">label</code>，此处一定要打上<code class="language-text">label</code>，<code class="language-text">learn-changelog</code>就是根据<code class="language-text">label</code>来确定该<code class="language-text">pr</code>属于<code class="language-text">feature</code>/<code class="language-text">bugfix</code>/<code class="language-text">document</code>等。</li><li>切记要在<code class="language-text">merge</code>之前打上<code class="language-text">label</code>。</li><li>进行<code class="language-text">merge pr</code>操作。</li><li>本地切换到<code class="language-text">master</code>分支并进行<code class="language-text">pull</code>操作。</li><li>执行<code class="language-text">lerna-changelog</code>，既可得到一份<code class="language-text">changeling</code>。</li></ul><h5 id="注意" class="heading"><a href="#%E6%B3%A8%E6%84%8F" aria-hidden="true"><span class="icon icon-link"></span></a>注意</h5><p><code class="language-text">pr</code>的<code class="language-text">label</code>并不能随意设置，一定要在项目中声明对应才生效。</p><p>官方默认支持<code class="language-text">breaking</code>/<code class="language-text">enhancement</code>/<code class="language-text">bug</code>/<code class="language-text">documentation</code>/<code class="language-text">internal</code>，如果想用其他，则需要在<code class="language-text">package.json</code>中进行相应的配置。</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"changelog"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"labels"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"feat"</span><span class="token operator">:</span> <span class="token string">":rocket: New Feature"</span><span class="token punctuation">,</span>
      <span class="token property">"bug"</span><span class="token operator">:</span> <span class="token string">":bug: Bug Fix"</span><span class="token punctuation">,</span>
      <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token string">":memo: Documentation"</span><span class="token punctuation">,</span>
      <span class="token property">"internal"</span><span class="token operator">:</span> <span class="token string">":house: Internal"</span><span class="token punctuation">,</span>
      <span class="token property">"breaking"</span><span class="token operator">:</span> <span class="token string">":boom: Breaking Change"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="子项目的changelog" class="heading"><a href="#%E5%AD%90%E9%A1%B9%E7%9B%AE%E7%9A%84changelog" aria-hidden="true"><span class="icon icon-link"></span></a>子项目的changelog</h4><p>尚未实践过，具体还需参考<a href="https://github.com/lerna/lerna/blob/514bc57a53/commands/version/README.md#--conventional-commits">README</a></p><h2 id="结语" class="heading"><a href="#%E7%BB%93%E8%AF%AD" aria-hidden="true"><span class="icon icon-link"></span></a>结语</h2><p><code class="language-text">lerna</code>的使用已介绍完毕，上述内容可满足日常开发需求，更多详情还需参考官方文档。</p></div><div class="comments"><div id="gitalk-container"></div></div></article></div></div></main><footer class="footer"><div class="center">Powered by <a target="_blank" href="https://github.com/acyortjs/acyort">AcyOrt</a> / Theme <a target="_blank" href="https://github.com/acyortjs/theme-donob">donob</a></div></footer><script src="/script/post.js"></script><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script>const gitalkConfig = JSON.parse('{"owner":"zWingz","repo":"my-blog-config","admin":["zWingz"],"clientID":"0438ed96c0cb944693a7","clientSecret":"23e7aa3152f5d03d8f20029540741d6f886c9f5b","number":27}')
  var gitalk = new Gitalk({
    ...gitalkConfig
  })
  gitalk.render('gitalk-container')</script><script defer="defer" src="/script/ribbon.js"></script></body></html>