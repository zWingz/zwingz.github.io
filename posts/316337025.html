<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="description" content="Just a blog."><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><title>Promise/A+规范以及实现 - zWing</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6650629ba7ddbfe98e2f63700c2e6923";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><canvas id="ribbon"></canvas><main class="main"><header class="header"><a class="logo" href="/">zWing</a><nav class="menu"><a href="/archives/">Archives</a><a href="/tags/">Tags</a><a href="/about/">About</a><a href="/repo/">Repo</a></nav><div class="social"><a target="_blank" href="/rss.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18,15.64A2.18,2.18 0 0,1 8.36,17.82C8.36,19 7.38,20 6.18,20C5,20 4,19 4,17.82A2.18,2.18 0 0,1 6.18,15.64M4,4.44A15.56,15.56 0 0,1 19.56,20H16.73A12.73,12.73 0 0,0 4,7.27V4.44M4,10.1A9.9,9.9 0 0,1 13.9,20H11.07A7.07,7.07 0 0,0 4,12.93V10.1Z"></path></svg> </a><a target="_blank" href="https://github.com/zWingz/my-blog-config/issues"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"></path></svg></a></div></header><div class="content-container center"><div id="post" class="flex"><aside class="toc"><div class="stay"><ul><li><a href="#promise-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">Promise 实现原理</a><ul><li><a href="#promise%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">Promise基本用法</a></li><li><a href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B">实现过程</a><ul><li><a href="#%E6%A0%B9%E6%8D%AEpromisea%E8%A7%84%E8%8C%83%E4%BB%A5%E4%B8%8B%E7%AE%80%E7%A7%B0%E8%A7%84%E8%8C%83%E4%B8%AD%E6%89%80%E8%AF%B4%E7%9A%84">根据<code>Promise/A+规范</code>(以下简称规范)中所说的</a></li><li><a href="#%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AAthen%E6%96%B9%E6%B3%95%E6%B2%A1%E6%9C%89%E5%AE%8C%E6%88%90-%E5%85%88%E7%9C%8B%E4%B8%8B%E8%A7%84%E8%8C%83%E6%80%8E%E4%B9%88%E8%AF%B4">还有一个<code>then</code>方法没有完成. 先看下规范怎么说</a></li><li><a href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%BB%A7%E7%BB%AD%E7%9C%8B%E4%B8%8B%E8%A7%84%E8%8C%83%E6%80%8E%E4%B9%88%E8%AF%B4">接下来继续看下规范怎么说</a></li><li><a href="#%E8%A7%84%E8%8C%83%E5%A4%96%E7%9A%84%E4%B8%80%E4%BA%9B%E4%B8%9C%E8%A5%BF">规范外的一些东西</a><ul><li><a href="#catch">catch</a></li><li><a href="#finally-es2018%E5%BC%95%E5%85%A5%E6%A0%87%E5%87%86">finally (ES2018引入标准)</a></li><li><a href="#promiseresolve%E5%92%8Cpromisereject-%E8%BF%99%E9%87%8C%E6%98%AF%E4%BB%8Ees6%E5%85%A5%E9%97%A8%E4%B8%AD%E7%9C%8B%E5%88%B0%E7%9A%84%E5%AE%9A%E4%B9%89">Promise.resolve和Promise.reject (这里是从ES6入门中看到的定义)</a></li></ul></li><li><a href="#%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98">开发过程中遇到其他问题</a><ul><li><a href="#node%E4%B8%AD%E7%9A%84unhandledrejection%E5%92%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84uncaught-in-promise-%E6%8F%90%E7%A4%BA">node中的<code>unhandledRejection</code>和浏览器中的<code>Uncaught (in promise)</code> 提示</a></li></ul></li></ul></li><li><a href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98">存在的问题</a></li><li><a href="#%E5%8F%82%E8%80%83">参考</a></li></ul></li></ul><span class="toc-icon"></span></div></aside><article class="post-content"><time class="time">April 20, 2018</time><h1 class="title">Promise/A+规范以及实现</h1><div><a href="/tags/819211154" class="tags-item" style="background: #92efc8;">Front End </a><a href="/tags/819211023" class="tags-item" style="background: #c5def5;">Js</a></div><div class="content"><h1 id="promise-实现原理" class="heading"><a href="#promise-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" aria-hidden="true"><span class="icon icon-link"></span></a>Promise 实现原理</h1><p><a href="https://github.com/zWingz/Promise">源码</a></p><h2 id="promise基本用法" class="heading"><a href="#promise%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95" aria-hidden="true"><span class="icon icon-link"></span></a>Promise基本用法</h2><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> val
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><p>Promise对象基本方法是<code class="language-text">then</code>, 而<code class="language-text">catch</code>是<code class="language-text">then</code>的一个变形, 相当于<code class="language-text">then(undefined, onReject)</code></p><h2 id="实现过程" class="heading"><a href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B" aria-hidden="true"><span class="icon icon-link"></span></a>实现过程</h2><p>根据Promise用法, 我们初步想到需要实现的方法是</p><ul><li>构造函数</li><li>resolve函数</li><li>reject函数</li><li>then函数</li></ul><p>此时Promise原型应为</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span>
<span class="token keyword">const</span> <span class="token constant">RESOLVED</span> <span class="token operator">=</span> <span class="token string">'RESOLVED'</span>
<span class="token keyword">const</span> <span class="token constant">REJECT</span> <span class="token operator">=</span> <span class="token string">'REJECT'</span>

<span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onReslove<span class="token punctuation">,</span> onReject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="根据promisea规范以下简称规范中所说的" class="heading"><a href="#%E6%A0%B9%E6%8D%AEpromisea%E8%A7%84%E8%8C%83%E4%BB%A5%E4%B8%8B%E7%AE%80%E7%A7%B0%E8%A7%84%E8%8C%83%E4%B8%AD%E6%89%80%E8%AF%B4%E7%9A%84" aria-hidden="true"><span class="icon icon-link"></span></a>根据<code class="language-text">Promise/A+规范</code>(以下简称规范)中所说的</h3><ul><li>Promise有三个状态 <code class="language-text">PENDING</code>, <code class="language-text">RESOLVED</code>, <code class="language-text">REJECTED</code></li><li>状态只会从<code class="language-text">PENDING</code>转换到<code class="language-text">RESOLVED</code>或者<code class="language-text">REJECTED</code>其中一个, 并且之后不会再改变</li><li>当Promise处于执行态时, 会有一个终值, 并且该值不会再改变</li><li>当Promise处于拒绝态时, 会有一个据因, 并且该据因不会再改变</li><li>当Promise由PENDING转换为RESOLVED时, 会触发<code class="language-text">onResolve</code>回调, 并且只执行一次</li><li>当Promise由PENDING转换为REJECTED时, 会触发<code class="language-text">onReject</code>回调, 并且只执行一次</li><li>Promise状态的转换时机在于开发者何时调用promise的resolve或者reject函数</li></ul><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 终值或者据因</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span> <span class="token comment">// 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onResolveCallBack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// resolved 回调</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectCallBack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// rejected 回调</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> val <span class="token comment">// 设置终值</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">RESOLVED</span> <span class="token comment">// 设置状态</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onResolveCallBack<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">each</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">each</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token comment">// 执行回调</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason <span class="token comment">// 设置据因</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECT</span> <span class="token comment">// 设置状态</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectCallBack<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">each</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">each</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token comment">// 执行回调</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onReslove<span class="token punctuation">,</span> onReject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里可能有人会说Promise应该是一个异步的过程, 在上面代码中并没有看到任何的异步. 比如说: setTimeout。</p><p>解答：</p><p>其实当创建一个Promise实例的时候，整个过程是同步的。</p><p>也就是说</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">res</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'after ins'</span><span class="token punctuation">)</span>

<span class="token comment">// 输出</span>
<span class="token comment">// Promise {&lt;resolved>: 10}</span>
<span class="token comment">// after ins</span>
</code></pre></div><p>当你执行完这一句， ins的状态会马上变成<code class="language-text">RESOLVED</code>. 说明在构造方法中并没有执行异步操作。如果真的需要异步的话，则需要主动在调用<code class="language-text">res</code>前，加上<code class="language-text">setTimeout</code>来触发异步。</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">res</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'after ins'</span><span class="token punctuation">)</span>

<span class="token comment">// 输出</span>
<span class="token comment">// Promise {&lt;pending>}</span>
<span class="token comment">// after ins</span>
</code></pre></div><h3 id="还有一个then方法没有完成-先看下规范怎么说" class="heading"><a href="#%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AAthen%E6%96%B9%E6%B3%95%E6%B2%A1%E6%9C%89%E5%AE%8C%E6%88%90-%E5%85%88%E7%9C%8B%E4%B8%8B%E8%A7%84%E8%8C%83%E6%80%8E%E4%B9%88%E8%AF%B4" aria-hidden="true"><span class="icon icon-link"></span></a>还有一个<code class="language-text">then</code>方法没有完成. 先看下规范怎么说</h3><ul><li>一个promise必须提供一个<code class="language-text">then</code>方法以访问当前值, 终止和据因</li><li>then接受两个参数<code class="language-text">then(onResolve, onReject)</code></li><li>onResolve和onReject都是可选, 如果不是函数则被忽略</li><li>onResolve方法在promise执行结束后被调用, 其第一个参数为promise的终值, 被调用次数不超过一次</li><li>onReject方法在promise被拒绝后被调用, 其第一个参数为promise的据因, 同样被调用次数不超过一次</li><li>onFulfilled 和 onRejected 只有在执行环境堆栈仅包含平台代码时才可被调用</li><li>如果onResolve和onReject返回一个值x, 则执行 <strong>Promise解决过程</strong></li><li>then方法必须返回一个<code class="language-text">promise</code>对象</li></ul><p>简单说就是</p><ul><li>如果promise处于pending, 则将then回调放入promise的回调列表中</li><li>如果promise处于resolved, 则实行then方法中的onResolve</li><li>如果promise处于rejected, 则执行then方法中的onReject</li><li>then方法要确保onResolve和onReject异步执行</li><li>onResolve和onReject返回的值都将用来解决下一个promise(后面再讲解)</li><li>返回新的promise(注意: 一定是新的promise)</li></ul><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onResolve<span class="token punctuation">,</span> onReject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">nextResolve<span class="token punctuation">,</span> nextReject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 加入到任务队列</span>
                self<span class="token punctuation">.</span>onResolveCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onResolve<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>onRejectCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onReject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 异步执行</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span>onResolve<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 异步执行</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span>onReject<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>此时Promise已经可以完成异步操作.</p><p>但是Promise还有一个关键特点是可以链式调用. 目前是还没有实现链式调用这一步.</p><p>具体代码看<a href="https://github.com/zWingz/Promise/blob/master/promise2.js">promise2.js</a></p><h3 id="接下来继续看下规范怎么说" class="heading"><a href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%BB%A7%E7%BB%AD%E7%9C%8B%E4%B8%8B%E8%A7%84%E8%8C%83%E6%80%8E%E4%B9%88%E8%AF%B4" aria-hidden="true"><span class="icon icon-link"></span></a>接下来继续看下规范怎么说</h3><p>Promise 解决过程</p><ul><li>blablabla 这里比较长</li></ul><p><strong>简单说就是</strong></p><p><code class="language-text">x</code>为<code class="language-text">then</code>方法中<code class="language-text">onResolve</code>或者<code class="language-text">onReject</code>中返回的值, <code class="language-text">promise2</code>为<code class="language-text">then</code>方法返回的新<code class="language-text">promise</code>.</p><p><code class="language-text">promise</code>的解决过程是一个抽象步骤. 需要输入一个<code class="language-text">promise</code>和一个<strong>值</strong>. 表示为<code class="language-text">[[Resolve]](promise, x)</code></p><ul><li>如果<code class="language-text">x</code>和<code class="language-text">promise2</code>相等, 则以<code class="language-text">TypeError</code>为据因拒绝执行promise2</li><li>如果<code class="language-text">x</code>为<code class="language-text">Promise</code>实例, 则让<code class="language-text">promise2</code>接受x的状态</li><li>如果<code class="language-text">x</code>为<code class="language-text">thenable</code>对象, 则调用其<code class="language-text">then</code>方法</li><li>如果都不满足, 则用<code class="language-text">x</code>为参数执行<code class="language-text">promise2</code></li></ul><p>继续修改then方法, 以及添加<code class="language-text">resolvePromise</code>来执行<code class="language-text">Promise</code>解决过程</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'function'</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">_isThenable</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">_isFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Promise 解决过程
 * 如果是thenable对象, 则触发该对象的then方法
 * 如果是一个值, 则直接调用resolve解析这个值
 * @param {Promise}} promise
 * @param {Object} x
 * @param {Function} resolve
 * @param {Function} reject
 */</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 要求每次返回新的promise</span>
  <span class="token comment">// 如果返回是当前的promise, 则抛出typeError</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token comment">// 判断是否thenable对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_isThenable</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> then <span class="token punctuation">}</span> <span class="token operator">=</span> x
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_isFunction</span><span class="token punctuation">(</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          x<span class="token punctuation">,</span>
          <span class="token parameter">val</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>called<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              called <span class="token operator">=</span> <span class="token boolean">true</span>
              <span class="token comment">// 如果不断的返回thenable</span>
              <span class="token comment">// 则需要不断地递归</span>
              <span class="token comment">// 但是实际上不应该不断的返回thenable</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> val<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>called<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              called <span class="token operator">=</span> <span class="token boolean">true</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//  非thenable, 则以该值来执行resolve</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">/**
   * then方法
   * @param {Function} [onFulfilled] 前then的resolve函数, 当promise为RESOLVE时,处理当前结果
   * @param {Function} onRejected 当前then的reject函数, 当promise被REJECT时调用
   * @returns {Promise}
   * @memberof Promise
   */</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token punctuation">:</span> <span class="token parameter">val</span> <span class="token operator">=></span> val
    onRejected <span class="token operator">=</span>
      <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span>
        <span class="token operator">?</span> <span class="token function-variable function">onRejected</span>
        <span class="token punctuation">:</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> err
          <span class="token punctuation">}</span>
    <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 如果有then方法调用, 则将hasThenHandle设为true</span>
    <span class="token comment">// console.log(this);</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hasThenHandle <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">/**
     * 返回一个新的promise, 用于链式调用
     */</span>
    <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 用try..catch包裹执行方法</span>
      <span class="token keyword">const</span> <span class="token function-variable function">tryCatchWrapper</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fnc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">fnc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 封装resolve方法回调</span>
      <span class="token keyword">const</span> doResolve <span class="token operator">=</span> <span class="token function">tryCatchWrapper</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 封装reject方法回调</span>
      <span class="token comment">// 如果当前then没有相应的reject回调</span>
      <span class="token keyword">const</span> doReject <span class="token operator">=</span> <span class="token function">tryCatchWrapper</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果当前promise还未执行完毕, 则设置回调</span>
        self<span class="token punctuation">.</span>onResolveCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>doResolve<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>onRejectCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>doReject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果为RESOLVE, 则异步执行resolve</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>doResolve<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果为REJECT, 则异步执行reject</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>doReject<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ret
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><p>至此一个<code class="language-text">Promise</code>可以说基本完成了.(完整代码请看<a href="https://github.com/zWingz/Promise/blob/master/index.js">index.js</a>)</p><h3 id="规范外的一些东西" class="heading"><a href="#%E8%A7%84%E8%8C%83%E5%A4%96%E7%9A%84%E4%B8%80%E4%BA%9B%E4%B8%9C%E8%A5%BF" aria-hidden="true"><span class="icon icon-link"></span></a>规范外的一些东西</h3><p>其实规范中定义的是<code class="language-text">Promise</code>的构建和执行过程.</p><p>而我们日常用到的却不至于规范中所提到的.</p><p>比如</p><ul><li>catch</li><li>finally</li><li>Promise.resolve</li><li>Promise.reject</li><li>all (未实现)</li><li>race (未实现)</li></ul><p>那接下来就说下关于这部分的实现</p><h4 id="catch" class="heading"><a href="#catch" aria-hidden="true"><span class="icon icon-link"></span></a>catch</h4><p>上面有提到. catch其实是<code class="language-text">then(undefined, reject)</code> 的简写. 所以这里比较简单</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 相当于新加入一个then方法</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><h4 id="finally-es2018引入标准" class="heading"><a href="#finally-es2018%E5%BC%95%E5%85%A5%E6%A0%87%E5%87%86" aria-hidden="true"><span class="icon icon-link"></span></a>finally (ES2018引入标准)</h4><p>finally函数作用我想大家都应该知道, 就是无论当前promise状态是如何. 都一定会执行回调.</p><p>finally方法中, 不接收任何参数, 所以并不能知道前面的Promise的状态.</p><p>同时, 他不会对promise产生影响.总是返回原来的值 所以在<code class="language-text">finally</code>中的操作,应该是与状态无关, 不依赖于promise的执行结果</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">finally</span><span class="token punctuation">(</span><span class="token function-variable function">fnc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">fnc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">fnc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> err
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><h4 id="promiseresolve和promisereject-这里是从es6入门中看到的定义" class="heading"><a href="#promiseresolve%E5%92%8Cpromisereject-%E8%BF%99%E9%87%8C%E6%98%AF%E4%BB%8Ees6%E5%85%A5%E9%97%A8%E4%B8%AD%E7%9C%8B%E5%88%B0%E7%9A%84%E5%AE%9A%E4%B9%89" aria-hidden="true"><span class="icon icon-link"></span></a>Promise.resolve和Promise.reject (这里是从ES6入门中看到的定义)</h4><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 调用形式</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
</code></pre></div><ul><li><p>Promise.resolve</p><p>根据arg的不同, 会执行不同的操作</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"> - arg为Promise实例, 则原封不动的返回这个实例
 - arg为thenable对象, 则会将arg转成promise, 并且立即执行`arg.then`方法(并不代表同步, 而是本轮事件循环结束时执行)
 - arg不满足上述情况, 则返回一个新的Promise实例, 状态为resolved, 终值为arg</code></pre></div><p>因此<code class="language-text">Promise.resolve</code>是一个更方便的创建<code class="language-text">Promise</code>实例的方法.</p></li><li><p>Promise.reject</p><p>这里就不会区分arg, 而是原封不动的把arg作为据因, 执行后续方法的调用.</p></li></ul><p>实现代码</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">/**
     * Promise.resolve
     * 将参数转成Promise对象
     * @static
     * @param {any} val
     * @returns {MPromise}
     * @memberof MPromise
     */</span>
    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果为MPromise实例</span>
        <span class="token comment">// 则返回该实例</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">_isThenable</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果为具有then方法的对象</span>
            <span class="token comment">// 则转为MPromise对象, 并且执行thenable</span>
            <span class="token comment">/**
             * @example
             * MPromise.resolve({
             *      then(res) {
             *          console.log('do promise')
             *          res(10)
             *      }
             *  })
             */</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 执行异步</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    val<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> rej<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果val为一个原始值,或者不具有then方法的对象</span>
        <span class="token comment">// 则返回一个新的MPromise对象,状态为resolved</span>
        <span class="token comment">/**
         * @example
         * MPromise.resolve()
         */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">res</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * reject方法参数会原封不动的作为据因而变成后续方法的参数
     * 且初始状态为REJECT
     * 不存在判别thenable
     * @static
     * @param {any} reason 
     * @returns 
     * @memberof MPromise
     */</span>
    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * @example
         * MPromise.reject('some error')
         */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">rej</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div><h3 id="开发过程中遇到其他问题" class="heading"><a href="#%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98" aria-hidden="true"><span class="icon icon-link"></span></a>开发过程中遇到其他问题</h3><h4 id="node中的unhandledrejection和浏览器中的uncaught-in-promise-提示" class="heading"><a href="#node%E4%B8%AD%E7%9A%84unhandledrejection%E5%92%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84uncaught-in-promise-%E6%8F%90%E7%A4%BA" aria-hidden="true"><span class="icon icon-link"></span></a>node中的<code class="language-text">unhandledRejection</code>和浏览器中的<code class="language-text">Uncaught (in promise)</code> 提示</h4><p>在Promise中产生的所有错误都会被Promise吞掉. 当没有相应的错误处理函数时候, node和浏览器分别有不同的表现.</p><p>但是这并不是一个新的错误, 因为不能用<code class="language-text">try{} catch(){}</code> 捕获.</p><p>所以在浏览器端, 是一个<code class="language-text">console.error</code>的错误提示, 在<code class="language-text">node</code>中, 这个算是一个事件. 具体可以通过<code class="language-text">process.on</code>来监听</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unhandledRejection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> err
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在编写代码中, 一开始卡在这一步挺久.</p><p>由于无法知道promise实例后续是否有相应的错误处理函数.</p><p>简单的判断<code class="language-text">onReject === undefined</code> 是不行的.</p><p>形如:</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">// 或者</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">rej</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这类是同步执行的, <code class="language-text">onReject === undefined</code> 恒为<code class="language-text">true</code>.</p><p>我的做法是给promise实例添加一个<code class="language-text">hasThenHandle</code>的属性, 在<code class="language-text">then</code>方法中将其设为<code class="language-text">true</code></p><p>在<code class="language-text">reject</code>方法中使用<code class="language-text">setTimeout</code>异步判断该值是否为<code class="language-text">true</code>, 如果不是则通过<code class="language-text">console.error</code>抛出提示.</p><p>其实在原生Promise中, 抛出的<code class="language-text">unhandledRejection</code> 也是属于异步的.</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'after Promise.reject'</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> rej</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">rej</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'after new Promise'</span><span class="token punctuation">)</span>

<span class="token comment">// 输出</span>
<span class="token comment">// after Promise.reject</span>
<span class="token comment">// after new Promise</span>
<span class="token comment">// Uncaught (in promise) 10</span>
<span class="token comment">// Uncaught (in promise) 10</span>
</code></pre></div><p>于是这个问题也能得到很好地解决.</p><p>至此完整代码已经结束, 具体看<code class="language-text">index.js</code>.</p><h2 id="存在的问题" class="heading"><a href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98" aria-hidden="true"><span class="icon icon-link"></span></a>存在的问题</h2><ul><li>由于用的是setTimeout模拟, 所以优先级不能保证高于setTimeout<ul><li>浏览器中可以用MessageChannel(macrotask)</li><li>node中可以用setImmediate(优先级在某些情况下比setTimeout高一些)</li><li>setTimeout和setImmediate在无IO操作下,两者执行顺序不确定,但是在IO操作下,setImmediate比setTimeout优先级高. 且setImmediate只在IE下有效</li></ul></li></ul><h2 id="参考" class="heading"><a href="#%E5%8F%82%E8%80%83" aria-hidden="true"><span class="icon icon-link"></span></a>参考</h2><p><a href="http://www.ituring.com.cn/article/66566">【翻译】Promises/A+规范</a></p><p><a href="http://es6.ruanyifeng.com/#docs/promise#Promise-prototype-finally">ECMAScript 6入门</a></p></div><div class="comments"><div id="gitalk-container"></div></div></article></div></div></main><footer class="footer"><div class="center">Powered by <a target="_blank" href="https://github.com/acyortjs/acyort">AcyOrt</a> / Theme <a target="_blank" href="https://github.com/acyortjs/theme-donob">donob</a></div></footer><script src="/script/post.js"></script><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script>const gitalkConfig = JSON.parse('{"owner":"zWingz","repo":"my-blog-config","admin":["zWingz"],"clientID":"0438ed96c0cb944693a7","clientSecret":"23e7aa3152f5d03d8f20029540741d6f886c9f5b","number":16}')
  var gitalk = new Gitalk({
    ...gitalkConfig
  })
  gitalk.render('gitalk-container')</script><script defer="defer" src="/script/ribbon.js"></script></body></html>