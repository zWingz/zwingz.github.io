<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="description" content="Hyrule - electron+react app开发实践"><meta name="keywords" content=""><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><title>Hyrule - electron+react app开发实践 - zWing</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6650629ba7ddbfe98e2f63700c2e6923";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><div class="indicator"></div><canvas id="ribbon"></canvas><main class="main"><header class="header"><a class="logo" href="/">zWing</a><nav class="menu"><a href="/archives/">Archives</a><a href="/tags/">Tags</a><a href="/about/">About</a><a href="/repo/">Repo</a></nav><div class="social"><a target="_blank" href="/rss.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18,15.64A2.18,2.18 0 0,1 8.36,17.82C8.36,19 7.38,20 6.18,20C5,20 4,19 4,17.82A2.18,2.18 0 0,1 6.18,15.64M4,4.44A15.56,15.56 0 0,1 19.56,20H16.73A12.73,12.73 0 0,0 4,7.27V4.44M4,10.1A9.9,9.9 0 0,1 13.9,20H11.07A7.07,7.07 0 0,0 4,12.93V10.1Z"></path></svg> </a><a target="_blank" href="https://github.com/zWingz/my-blog-config/issues"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"></path></svg></a></div></header><div class="content-container center"><div id="post" class="flex"><aside class="toc"><div class="stay"><ul><li><a href="#%E8%83%8C%E6%99%AF">背景</a></li><li><a href="#%E6%8A%80%E6%9C%AF%E6%A0%88%E4%BB%A5%E5%8F%8A%E4%B8%BB%E8%A6%81%E4%BE%9D%E8%B5%96">技术栈以及主要依赖</a></li><li><a href="#electron%E5%A6%82%E4%BD%95%E8%BF%90%E8%A1%8Cweb">electron如何运行web</a></li><li><a href="#%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8">项目启动</a></li><li><a href="#%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91">项目开发</a><ul><li><a href="#github-%E8%AE%A4%E8%AF%81">github 认证</a><ul><li><a href="#%E7%94%A8%E6%88%B7%E8%87%AA%E8%A1%8C%E8%BE%93%E5%85%A5token">用户自行输入token</a></li><li><a href="#%E9%80%9A%E8%BF%87oauth20%E6%8E%88%E6%9D%83%E8%8E%B7%E5%8F%96token">通过oauth2.0授权获取token</a></li></ul></li><li><a href="#api-service%E5%BC%80%E5%8F%91">api service开发</a></li><li><a href="#service-%E4%BA%8C%E6%AC%A1%E5%B0%81%E8%A3%85">service 二次封装</a><ul><li><a href="#%E5%9B%BE%E5%BA%8A%E9%83%A8%E5%88%86service">图床部分service</a></li></ul></li><li><a href="#%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BDgithub%E5%9B%BE%E7%89%87">如何加载github图片</a></li><li><a href="#cache%E7%BC%93%E5%AD%98">cache缓存</a></li><li><a href="#%E5%BC%82%E6%AD%A5%E9%98%9F%E5%88%97">异步队列</a></li><li><a href="#monaco%E7%BC%96%E8%BE%91%E5%99%A8%E5%8A%A0%E8%BD%BD">monaco编辑器加载</a><ul><li><a href="#%E6%B7%BB%E5%8A%A0%E5%BF%AB%E6%8D%B7%E9%94%AE%E7%9B%91%E5%90%AC">添加快捷键监听</a></li><li><a href="#%E7%B2%98%E8%B4%B4%E5%9B%BE%E7%89%87%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0">粘贴图片直接上传</a></li></ul></li><li><a href="#markdown%E9%A2%84%E8%A7%88%E4%BB%A5%E5%8F%8A%E6%BB%9A%E5%8A%A8%E5%90%8C%E6%AD%A5">markdown预览以及滚动同步</a><ul><li><a href="#%E6%BB%9A%E5%8A%A8%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86">滚动同步原理</a></li><li><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">代码实现</a><ul><li><a href="#%E8%8E%B7%E5%8F%96monaco-editor%E9%9A%90%E8%97%8F%E7%9A%84%E8%A1%8C%E6%95%B0">获取monaco-editor隐藏的行数</a></li><li><a href="#%E6%B8%B2%E6%9F%93%E5%B9%B6%E8%AE%A1%E7%AE%97%E9%9A%90%E8%97%8F%E5%8C%BA%E5%9F%9F%E7%9A%84%E9%AB%98%E5%BA%A6">渲染并计算隐藏区域的高度</a></li><li><a href="#%E8%AE%BE%E7%BD%AE%E6%B8%B2%E6%9F%93%E5%8C%BAscrolltop">设置渲染区scrollTop</a></li></ul></li></ul></li></ul></li><li><a href="#%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85">项目打包</a></li><li><a href="#%E7%BB%93%E8%AF%AD">结语</a></li></ul><span class="toc-icon"></span></div></aside><article class="post-content"><time class="time">September 05, 2019</time><h1 class="title">Hyrule - electron+react app开发实践</h1><div class="content"><h2 id="背景" class="heading"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true"><span class="icon icon-link"></span></a>背景</h2><p><a href="https://github.com/zWingz/Hyrule">Hyrule</a></p><p>本文也是在Hyrule下完成</p><h2 id="技术栈以及主要依赖" class="heading"><a href="#%E6%8A%80%E6%9C%AF%E6%A0%88%E4%BB%A5%E5%8F%8A%E4%B8%BB%E8%A6%81%E4%BE%9D%E8%B5%96" aria-hidden="true"><span class="icon icon-link"></span></a>技术栈以及主要依赖</h2><ul><li><a href="https://github.com/facebook/react">react</a></li><li><a href="https://github.com/ant-design/ant-design">antd</a></li><li><a href="https://github.com/electron/electron">electron</a></li><li><a href="https://github.com/microsoft/TypeScript">typescript</a></li><li><a href="https://github.com/microsoft/monaco-editor">monaco-editor</a></li><li><a href="https://github.com/remarkjs/remark">remark</a></li></ul><p>electron提供跨平台PC端运行环境，使用react+antd构建UI界面</p><p>monaco-editor提供编辑器功能，使用remark转换markdown</p><h2 id="electron如何运行web" class="heading"><a href="#electron%E5%A6%82%E4%BD%95%E8%BF%90%E8%A1%8Cweb" aria-hidden="true"><span class="icon icon-link"></span></a>electron如何运行web</h2><p>electron作用就是提供多端运行环境，实际开发体验跟一般Web开发无二</p><p>万事开头难，初次接触的确不知道如何入手，github上也有相应的模板</p><ul><li><a href="https://github.com/SimulatedGREG/electron-vue">electron-vue</a></li><li><a href="https://github.com/electron-react-boilerplate/electron-react-boilerplate">electron-react-boilerplate</a></li></ul><p>不管模板如何，核心还是如何在electron中加载html</p><p>electron分为主进程(main)和渲染进程(renderer)，主进程可以跟操作系统打交道，渲染进程可以说跟页面打交道(webapp)，因此只需要在主进程创建一个<code class="language-text">window</code>来跑页面即可。</p><p>如果只是开发普通页面，那只要加载html即可，如果使用webpack开发，则开发时候需要在electron中访问dev-server提供的页面</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 创建一个window, 用于加载html</span>
  title<span class="token operator">:</span> app<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  minHeight<span class="token operator">:</span> <span class="token number">750</span><span class="token punctuation">,</span>
  minWidth<span class="token operator">:</span> <span class="token number">1090</span><span class="token punctuation">,</span>
  webPreferences<span class="token punctuation">,</span>
  show<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 避免app启动时候显示出白屏</span>
  backgroundColor<span class="token operator">:</span> <span class="token string">'#2e2c29'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isDev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  win<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8989/'</span><span class="token punctuation">)</span> <span class="token comment">// 开发环境访问dev-server提供的页面</span>
  <span class="token comment">// 配置react-dev-tool</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span> installExtension<span class="token punctuation">,</span>
    <span class="token constant">REACT_DEVELOPER_TOOLS</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'electron-devtools-installer'</span><span class="token punctuation">)</span>
  <span class="token function">installExtension</span><span class="token punctuation">(</span><span class="token constant">REACT_DEVELOPER_TOOLS</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>name <span class="token operator">=></span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Added Extension:  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=></span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'An error occurred: '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// win.webContents.openDevTools()</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生产环境直接加载index.html</span>
  win<span class="token punctuation">.</span><span class="token function">loadFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/../../../renderer/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此, 就可以在electron中运行开发的webapp, 剩下的工作便跟日常开发一样</p><h2 id="项目启动" class="heading"><a href="#%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8" aria-hidden="true"><span class="icon icon-link"></span></a>项目启动</h2><p>如上面所说, 在启动开发环境时候, 需要两个进程</p><ul><li>devServer: 使用webpack来启动webapp开发环境</li><li>electron: 直接使用node来执行main.js, 启动electron</li></ul><p>但由于使用typescript来开发, 在web端可以由webpack来完成, 那么在electron中, 则多了一步来编译</p><p>因此整个开发环境启动有三步</p><ul><li>dev:web 启动dev-server</li><li>dev:main 编译main.ts到./dist/main.js</li><li>dev:electron 执行main.js, 启动electron(借助nodemon来自动重启)</li></ul><p>目前还未特意去寻找一键启动方法, 因此启动步骤稍微多</p><div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev:web"</span><span class="token operator">:</span> <span class="token string">"node ./build/devServer.js"</span><span class="token punctuation">,</span>
    <span class="token property">"build:web"</span><span class="token operator">:</span> <span class="token string">"webpack --progress --hide-modules --colors --config=build/prod.conf.js"</span><span class="token punctuation">,</span>
    <span class="token property">"dev:main"</span><span class="token operator">:</span> <span class="token string">"yarn build:main --watch"</span><span class="token punctuation">,</span>
    <span class="token property">"build:main"</span><span class="token operator">:</span> <span class="token string">"tsc -p tsconfig.electron.json"</span><span class="token punctuation">,</span>
    <span class="token property">"dev:electron"</span><span class="token operator">:</span> <span class="token string">"nodemon --watch ./dist/main --exec electron ./dist/electron/src/main/main.js"</span><span class="token punctuation">,</span>
    <span class="token property">"build:package"</span><span class="token operator">:</span> <span class="token string">"electron-builder --config ./electronrc.js -mwl"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"yarn build:web &amp;&amp; yarn build:main &amp;&amp; yarn build:package"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="项目开发" class="heading"><a href="#%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91" aria-hidden="true"><span class="icon icon-link"></span></a>项目开发</h2><p>接下来, 只需要重点开发webapp即可, electron端可以作为辅助, 提供一些系统级别调用功能</p><p>下面讲讲开发过程中遇到的问题以及解决方法</p><h3 id="github-认证" class="heading"><a href="#github-%E8%AE%A4%E8%AF%81" aria-hidden="true"><span class="icon icon-link"></span></a>github 认证</h3><p>由于app是基于github来完成, 因此所有功能都需要对接github api</p><p>github大部分api都是对外开放, 当需要访问私有仓库或者进行敏感操作时候才需要token</p><p>但是不使用token的话, api有调用次数限制</p><p>获取token有两种方式</p><ul><li>直接让用户输入<code class="language-text">access token</code></li><li>通过github app形式来交换token</li></ul><h4 id="用户自行输入token" class="heading"><a href="#%E7%94%A8%E6%88%B7%E8%87%AA%E8%A1%8C%E8%BE%93%E5%85%A5token" aria-hidden="true"><span class="icon icon-link"></span></a>用户自行输入token</h4><p>第一种方式显然是最简单的, 只需要提供一个<code class="language-text">form</code>表单让用户输入<code class="language-text">access token</code></p><h4 id="通过oauth20授权获取token" class="heading"><a href="#%E9%80%9A%E8%BF%87oauth20%E6%8E%88%E6%9D%83%E8%8E%B7%E5%8F%96token" aria-hidden="true"><span class="icon icon-link"></span></a>通过oauth2.0授权获取token</h4><p>oauth2.0授权步骤大概如下:</p><ul><li>在github申请github app, 并获取<code class="language-text">CLIENT_ID</code>和<code class="language-text">SECRET</code>, 并填写回调地址</li><li>引导用户访问<code class="language-text">https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}</code></li><li>用户授权后github会带上<code class="language-text">code</code>并跳转到回调地址</li><li>拿到<code class="language-text">code</code>后请求<code class="language-text">https://github.com/login/oauth/access_token</code>获取用户<code class="language-text">access_token</code></li><li>拿到<code class="language-text">access_token</code>就可以调用github api</li></ul><p>由于需要提供回调地址, 而<code class="language-text">Hyrule</code>并不需要任何服务器, 因此在回调这一步需要做些处理</p><ul><li><p>回调地址填写<code class="language-text">localhost</code>, 用户授权后会跳转回我们开发的web页面, 控制权又回到我们手上</p></li><li><p>在electron中可以监听跳转, 因此在监听到跳转时候阻止默认事件, 并获取<code class="language-text">url</code>上的<code class="language-text">code</code>, 接下来获取<code class="language-text">access_token</code>即可</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript">authWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'will-redirect'</span><span class="token punctuation">,</span> handleOauth<span class="token punctuation">)</span>
authWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'will-navigate'</span><span class="token punctuation">,</span> handleOauth<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">handleOauth</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">code=([\d\w]+)</span><span class="token regex-delimiter">/</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> authUrl <span class="token operator">=</span> <span class="token string">'https://github.com/login/oauth/access_token'</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span>authUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      code<span class="token punctuation">,</span>
      client_id<span class="token operator">:</span> <span class="token constant">GITHUB_APP</span><span class="token punctuation">.</span><span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
      client_secret<span class="token operator">:</span> <span class="token constant">GITHUB_APP</span><span class="token punctuation">.</span><span class="token constant">SECRET</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      Accept<span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
      Referer<span class="token operator">:</span> <span class="token string">'https://github.com/'</span><span class="token punctuation">,</span>
      <span class="token string-property property">'User-Agent'</span><span class="token operator">:</span>
        <span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> access_token <span class="token punctuation">}</span> <span class="token operator">=</span> r
        <span class="token function">setToken</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span>
        <span class="token comment">// Close the browser if code found or error</span>
        <span class="token function">getWin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'set-access-token'</span><span class="token punctuation">,</span> access_token<span class="token punctuation">)</span>
        authWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">clearStorageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        authWindow<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul><h3 id="api-service开发" class="heading"><a href="#api-service%E5%BC%80%E5%8F%91" aria-hidden="true"><span class="icon icon-link"></span></a>api service开发</h3><p>做api service开发只是为了更快速调动github api</p><p>npm上也有<a href="https://github.com/octokit/rest.js">@octokit/rest</a>, 已经封装好了所有github api, 文档也足够齐全, 但由于笨app用到接口不多, 因此我选择了自行封装</p><p>列举下所用接口</p><ul><li>获取当前用户</li><li>获取用户所有repo, 包括private</li><li>获取/创建/编辑/删除issues</li><li>获取repo的tree数据</li><li>获取文件<code class="language-text">blob</code>数据 (获取content接口有大小限制, 获取<code class="language-text">blob</code>没有)</li><li>创建和删除<code class="language-text">file</code></li></ul><p>刚开始直接使用<code class="language-text">fetch</code>来请求api, 后面发现<code class="language-text">fetch</code>并不能获取上传进度, 后续改回了<code class="language-text">xhr</code></p><h3 id="service-二次封装" class="heading"><a href="#service-%E4%BA%8C%E6%AC%A1%E5%B0%81%E8%A3%85" aria-hidden="true"><span class="icon icon-link"></span></a>service 二次封装</h3><p>api service提供最基础的api调用, 需要再进一步封装以满足功能需求</p><h4 id="图床部分service" class="heading"><a href="#%E5%9B%BE%E5%BA%8A%E9%83%A8%E5%88%86service" aria-hidden="true"><span class="icon icon-link"></span></a>图床部分service</h4><p>列举下图床所需要service</p><ul><li>获取repo下某sha的tree data(其实就是获取repo的目录结构, 默认第一层为<code class="language-text">master</code>)</li><li>上传图片和删除图片</li></ul><p>看似所需要接口不多, 但实际开发起来还是花了不少时间, 不过更多是在优化流程上</p><h3 id="如何加载github图片" class="heading"><a href="#%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BDgithub%E5%9B%BE%E7%89%87" aria-hidden="true"><span class="icon icon-link"></span></a>如何加载github图片</h3><p>github仓库分为了public和private, 而public仓库的文件可以直接通过<code class="language-text">https://raw.githubusercontent.com/user/repo/${branch-or-sha}/${path-to-file}</code>访问. 而private则需要通过token方式访问</p><ul><li><a href="https://developer.github.com/v3/git/blobs/#git-blobs">git-blobs</a>: 可以获取任何文件, 返回base64</li><li><a href="https://developer.github.com/v3/repos/contents/#get-contents">contents</a>: 可以获取1mb以内的文件, 返回base64</li><li>通过<code class="language-text">https://access_token@github.com/user/repo/path/to/file</code> 由于此形式有安全隐患, 因此无法直接用在<code class="language-text">&lt;img /></code>上, 但是可以通过<code class="language-text">curl</code>形式使用</li><li>带上<code class="language-text">Authorization</code>访问raw.githubusercontent.com<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://raw.githubusercontent.com/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>owner<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>repo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/master/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">token </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul><p>对于public的仓库, 直接通过<code class="language-text">img</code>标签即可, 对于private, 则需要多一步处理.</p><p>通过github api获取图片base64后拼接上MIME赋值给<code class="language-text">img.src</code>即可, 如果觉得base64太长, 可以进一步转成blob-url, 并且加上缓存, 则对于同一张图片只需要加载一次即可.</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// base64转blob</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">b64toblob</span><span class="token punctuation">(</span>b64Data<span class="token punctuation">,</span> contentType <span class="token operator">=</span> <span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>contentType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b64Data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> blob
<span class="token punctuation">}</span>
</code></pre></div><p>按理说上面的方法已经很好地解决private图片加载, 但由于使用了<a href="https://github.com/zWingz/react-image">react-image</a>图片组件, 会自动根据图片加载情况添加对应加载状态, 如果使用上述方法, 会导致图片先显示<code class="language-text">error</code>然后才转成正常图片.</p><p>想要private图片也能直接通过src形式加载, 需要一个"后台"帮我们加载图片, 然后返回对应的<code class="language-text">http response</code>, 而恰好electron上可以<a href="https://electronjs.org/docs/api/protocol#protocol">自定义协议</a>, 并进行拦截, 那么我们可以定义一个<code class="language-text">github:</code>协议, 所有该<code class="language-text">url</code>都由electron拦截并处理</p><p>这里我选择了<a href="https://electronjs.org/docs/api/protocol#protocolregisterstreamprotocolscheme-handler-completion">streamprotocol</a></p><p>整体流程大概如下:</p><ul><li>electron注册自定义协议<code class="language-text">github://</code></li><li>构造图片src: <code class="language-text">github://${repo}/${sha}/${name}</code></li><li>electron拦截请求, 解析得到<code class="language-text">repo</code>, <code class="language-text">sha</code>和<code class="language-text">name</code>信息</li><li>electron发起github api, 得到图片的base64</li><li>将base64转成buffer, 并构造成<code class="language-text">Readable</code>后返回</li></ul><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 注册协议</span>
<span class="token keyword">function</span> <span class="token function">registerStreamProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  protocol<span class="token punctuation">.</span><span class="token function">registerStreamProtocol</span><span class="token punctuation">(</span><span class="token string">'github'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> req
    <span class="token function">getImageByApi</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getImageByApi</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  _token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    stream<span class="token operator">?</span><span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ReadableStream <span class="token operator">|</span> Electron<span class="token punctuation">.</span>StreamProtocolResponse
  <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 解析url</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> src<span class="token punctuation">]</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'//'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>src<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>owner<span class="token punctuation">,</span> repo<span class="token punctuation">,</span> sha<span class="token punctuation">,</span> name<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> ext<span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取图片数据</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.github.com/repos/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>owner<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>repo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/git/blobs/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sha<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">token </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> res <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">any</span>
    <span class="token comment">// 转成Buffer</span>
    <span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span>
    <span class="token comment">// 构造Readable</span>
    <span class="token keyword">const</span> read <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    read<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
    read<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span>headers
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      statusCode<span class="token operator">:</span> res<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
      data<span class="token operator">:</span> read<span class="token punctuation">,</span>
      <span class="token comment">// 将对应头部也带上</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'Content-Length'</span><span class="token operator">:</span> data<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">image/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ext<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token string-property property">'Cache-Control:'</span><span class="token operator">:</span> <span class="token string">'public'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'Accept-Ranges'</span><span class="token operator">:</span> <span class="token string">'bytes'</span><span class="token punctuation">,</span>
        Status<span class="token operator">:</span> res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Status'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Date<span class="token operator">:</span> res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Etag<span class="token operator">:</span> res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'etag'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'Last-Modified'</span><span class="token operator">:</span> res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Last-Modified'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除了使用github api, 也可以直接通过<code class="language-text">raw</code>获取, 类似一个请求转发</p><p>按道理这样返回该请求的相应是最直接的方法, 但是该方法是在太慢了, 对node不够精通, 暂时想不到原因</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">getImageByRaw</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  _token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    stream<span class="token operator">?</span><span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>ReadableStream <span class="token operator">|</span> Electron<span class="token punctuation">.</span>StreamProtocolResponse
  <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> src<span class="token punctuation">]</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'//'</span><span class="token punctuation">)</span>
  <span class="token comment">// /repos/:owner/:repo/git/blobs/:sha</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>owner<span class="token punctuation">,</span> repo<span class="token punctuation">,</span> <span class="token punctuation">,</span> name<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token comment">// 直接fetch raw文件, 并且带上authorization即可</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://raw.githubusercontent.com/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>owner<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>repo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/master/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">token </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接返回reabable</span>
    <span class="token comment">// 但是太慢了, 不知道为何</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      headers<span class="token operator">:</span> res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> res<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
      statusCode<span class="token operator">:</span> res<span class="token punctuation">.</span>status
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="cache缓存" class="heading"><a href="#cache%E7%BC%93%E5%AD%98" aria-hidden="true"><span class="icon icon-link"></span></a>cache缓存</h3><p>在图片管理中目录结构, 其实就是对应git上的一棵<code class="language-text">tree</code>, 而要达到同步效果, 必须从github中拉取对应的<code class="language-text">tree data</code></p><p>但其实只需要在该tree第一次加载时候去github拉取数据, 一旦数据拉取到本地, 后续目录读取就可以脱离github</p><ul><li>第一次访问根目录</li><li>拉取master目录结构</li><li>进入目录A</li><li>根据目录A的<code class="language-text">sha</code>拉取其目录结构</li><li>返回根目录</li><li>直接读取缓存中目录结构</li></ul><p>可见所有目录只需要拉取一次数据即可, 后续操作只需要在本地cache中完成</p><p>那么可以构造一个简单的缓存数据结构</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Cache<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  _cache<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>k<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">T</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> data
  <span class="token punctuation">}</span>
  <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">return</span> ret
  <span class="token punctuation">}</span>
  <span class="token function">has</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cache
  <span class="token punctuation">}</span>
  <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ImgType</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
  url<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  sha<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">DirType</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>k<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">DataJsonType</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  images<span class="token operator">:</span> ImgType<span class="token punctuation">[</span><span class="token punctuation">]</span>
  dir<span class="token operator">:</span> DirType
  sha<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ImageCache</span> <span class="token keyword">extends</span> <span class="token class-name">Cache<span class="token operator">&lt;</span>DataJsonType<span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token function">addImg</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> img<span class="token operator">:</span> ImgType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>images<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">delImg</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> img<span class="token operator">:</span> ImgType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cac <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    cac<span class="token punctuation">.</span>images <span class="token operator">=</span> cac<span class="token punctuation">.</span>images<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>each <span class="token operator">=></span> each<span class="token punctuation">.</span>sha <span class="token operator">!==</span> img<span class="token punctuation">.</span>sha<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>只要缓存中没有对应的key, 则从github上面拉取数据, 如果存在则直接在该缓存中操作, 每次增加或删除图片, 只需要更新其<code class="language-text">sha</code>即可.</p><p>举例:</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">ImageKit</span> <span class="token punctuation">{</span>
  <span class="token function">uploadImage</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> img<span class="token operator">:</span> UploadImageType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> img
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">uploadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 获取缓存中数据</span>
    cache<span class="token punctuation">.</span><span class="token function">addImg</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> filename<span class="token punctuation">,</span>
      sha<span class="token operator">:</span> d<span class="token punctuation">.</span>sha
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于issues也是同样方法来缓存, 只不过数据结构有点变化, 这里就不叙述.</p><h3 id="异步队列" class="heading"><a href="#%E5%BC%82%E6%AD%A5%E9%98%9F%E5%88%97" aria-hidden="true"><span class="icon icon-link"></span></a>异步队列</h3><p>github api有提供批量操作tree的<a href="https://developer.github.com/v3/git/trees/#create-a-tree">接口</a>, 但是并没有想象中那么容易使用, 反而有点复杂</p><p>在这里便没有考虑通过操作tree形式完成批量上传, 而是将批量上传拆分成一个个任务逐个上传, 也就说在交互上批量, 实际上还是单一.</p><p>这里用了<a href="https://github.com/zWingz/lite-queue">lite-queue</a>来管理异步队列(这个库也是后来才拆出来的), 使用方法很简单</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token comment">// 1000</span>
</code></pre></div><p>其实就是根据调用顺序, 保证上一个<code class="language-text">promise</code>执行完后才执行下一个, 并且提供正确的回调和类似<code class="language-text">Promise.all</code>操作</p><h3 id="monaco编辑器加载" class="heading"><a href="#monaco%E7%BC%96%E8%BE%91%E5%99%A8%E5%8A%A0%E8%BD%BD" aria-hidden="true"><span class="icon icon-link"></span></a>monaco编辑器加载</h3><p>这里选择<a href="https://microsoft.github.io/monaco-editor/">monaco-editor</a>作为编辑器, 对于使用<code class="language-text">vscode</code>的开发者来说这样更容易上手</p><p>如何初始化, <a href="https://github.com/microsoft/monaco-editor/blob/master/docs/integrate-esm.md">官方文档</a>有详细说明, 下面附上初始化配置</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> monaco<span class="token punctuation">.</span>editor<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'monaco-editor'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> content<span class="token punctuation">,</span>
  language<span class="token operator">:</span> <span class="token string">'markdown'</span><span class="token punctuation">,</span>
  automaticLayout<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  minimap<span class="token operator">:</span> <span class="token punctuation">{</span>
    enabled<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  wordWrap<span class="token operator">:</span> <span class="token string">'wordWrapColumn'</span><span class="token punctuation">,</span>
  lineNumbers<span class="token operator">:</span> <span class="token string">'off'</span><span class="token punctuation">,</span>
  roundedSelection<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  theme<span class="token operator">:</span> <span class="token string">'vs-dark'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="添加快捷键监听" class="heading"><a href="#%E6%B7%BB%E5%8A%A0%E5%BF%AB%E6%8D%B7%E9%94%AE%E7%9B%91%E5%90%AC" aria-hidden="true"><span class="icon icon-link"></span></a>添加快捷键监听</h4><p>监听<code class="language-text">CtrlOrCmd + S</code>完成文章保存</p><p>monaco-editor有提供相关api, 这里直接上代码</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token constant">KM</span> <span class="token operator">=</span> monaco<span class="token punctuation">.</span>KeyMod
<span class="token keyword">const</span> <span class="token constant">KC</span> <span class="token operator">=</span> monaco<span class="token punctuation">.</span>KeyCode
<span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">.</span><span class="token function">addCommand</span><span class="token punctuation">(</span><span class="token constant">KM</span><span class="token punctuation">.</span>CtrlCmd <span class="token operator">|</span> <span class="token constant">KC</span><span class="token punctuation">.</span><span class="token constant">KEY_S</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>onSave<span class="token punctuation">)</span>
</code></pre></div><h4 id="粘贴图片直接上传" class="heading"><a href="#%E7%B2%98%E8%B4%B4%E5%9B%BE%E7%89%87%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0" aria-hidden="true"><span class="icon icon-link"></span></a>粘贴图片直接上传</h4><p>写文章难免不了贴图片, 而贴图片意味着需要有一个图床, 结合hyrule, 可以借助github做图床, 然后在文章中引入, 步骤分别为:</p><ul><li>上传图片</li><li>复制markdown url</li><li>粘贴在文章中</li></ul><p>而最理想的操作是直接拖动到编辑器或者<code class="language-text">ctrl + v</code>粘贴图片, 在github issues中我们也可以直接粘贴图片并完成图片上传, 这里就可以模仿github的交互</p><ul><li>用户上传图片</li><li>确定当前光标所在位置</li><li>插入<code class="language-text">(Uploading...)</code>提示</li><li>图片上传完后替换掉上一部的<code class="language-text">(Uploading...)</code></li><li>完成图片插入</li></ul><p>浏览器有提供监听<code class="language-text">paste</code>的接口, 而确定光标位置以及文本替换就要借助monaco-editor的api了</p><p>分别是:</p><ul><li><a href="https://microsoft.github.io/monaco-editor/api/interfaces/monaco.editor.istandalonecodeeditor.html#getselection">getSelection</a>: 获取光标位置</li><li><a href="https://microsoft.github.io/monaco-editor/api/interfaces/monaco.editor.istandalonecodeeditor.html#executeedits">executeEdits</a>: 执行文本替换</li><li><a href="https://microsoft.github.io/monaco-editor/api/interfaces/monaco.editor.istandalonecodeeditor.html#setposition">selection</a>: 恢复光标位置</li><li><a href="https://microsoft.github.io/monaco-editor/api/interfaces/monaco.irange.html">monaco.Range</a>: 创建一个range</li></ul><p>逻辑步骤为:</p><ul><li>获取当前用户光标位置, 记录为<code class="language-text">startSelection</code>,</li><li>从<code class="language-text">clipboardData</code>中获取上传的<code class="language-text">file</code></li><li>再次获取当前光标, 记录为<code class="language-text">endSelection</code>, 两个selection可以确定上传前的选区</li><li>根据<code class="language-text">startSelection</code>和<code class="language-text">endSelection</code>创建一个<code class="language-text">range</code></li><li>调用<code class="language-text">executeEdits</code>, 在上一步的<code class="language-text">range</code>中执行文本插入, 插入<code class="language-text">![](Uplaoding...)</code></li><li>再次获取当前光标, 记录为<code class="language-text">endSelection</code>,此时光标在<code class="language-text">uploading...</code>之后, 用于后续替换</li><li>上传图片</li><li>根据<code class="language-text">start</code>和<code class="language-text">end</code>再次创建<code class="language-text">range</code></li><li>调用<code class="language-text">executeEdits</code>插入图片<code class="language-text">![](imgUrl)</code></li><li>获取光标后立即调用<code class="language-text">setPosition</code>, 可以将光标恢复到图片文字后</li><li>完成图片上传</li></ul><p>代码如下:</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'paste'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onPaste<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">onPaste</span><span class="token punctuation">(</span>e<span class="token operator">:</span> ClipboardEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> editor <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span><span class="token function">hasTextFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startSelection <span class="token operator">=</span> editor<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>clipboardData
    <span class="token comment">// 以startSelection为头, 创建range</span>
    <span class="token keyword">const</span> <span class="token function-variable function">createRange</span> <span class="token operator">=</span> <span class="token punctuation">(</span>end<span class="token operator">:</span> monaco<span class="token punctuation">.</span>Selection<span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token keyword">new</span> <span class="token class-name">monaco</span><span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>
        startSelection<span class="token punctuation">.</span>startLineNumber<span class="token punctuation">,</span>
        startSelection<span class="token punctuation">.</span>startColumn<span class="token punctuation">,</span>
        end<span class="token punctuation">.</span>endLineNumber<span class="token punctuation">,</span>
        end<span class="token punctuation">.</span>endColumn
      <span class="token punctuation">)</span>
    <span class="token comment">// 使用setTimeout, 可以确保光标恢复在选区之后</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> endSelection <span class="token operator">=</span> editor<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> range <span class="token operator">=</span> <span class="token function">createRange</span><span class="token punctuation">(</span>endSelection<span class="token punctuation">)</span>
      <span class="token comment">// generate fileName</span>
      <span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token comment">// copy img url to editor</span>
      editor<span class="token punctuation">.</span><span class="token function">executeEdits</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> range<span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">![](Uploading...)</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token comment">// get new range</span>
      range <span class="token operator">=</span> <span class="token function">createRange</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">uploadImage</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
      <span class="token comment">// copy img url to editor</span>
      editor<span class="token punctuation">.</span><span class="token function">executeEdits</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> range<span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">![](</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      editor<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="markdown预览以及滚动同步" class="heading"><a href="#markdown%E9%A2%84%E8%A7%88%E4%BB%A5%E5%8F%8A%E6%BB%9A%E5%8A%A8%E5%90%8C%E6%AD%A5" aria-hidden="true"><span class="icon icon-link"></span></a>markdown预览以及滚动同步</h3><p>要做markdown编辑器, 少不了即时预览功能, 而即时预览又少不了滚动同步</p><p>该功能刚开始也花了不少时间去思考如何实现</p><p>第一次实现方案是根据编辑器滚动的百分比, 来设置预览区的百分比, 但其实这样并不合适, 举例子就是插入一张图, 只占据编辑器一行, 而渲染区可以占据很大的空间</p><p>其实网上也有不少实现方法, 我这里也讲讲我的实现方法, 用起来还是蛮好的..</p><h4 id="滚动同步原理" class="heading"><a href="#%E6%BB%9A%E5%8A%A8%E5%90%8C%E6%AD%A5%E5%8E%9F%E7%90%86" aria-hidden="true"><span class="icon icon-link"></span></a>滚动同步原理</h4><p>滚动同步最主要的是渲染当前编辑器中的内容, 而编辑器隐藏的, 是我们不需要渲染的, 换一个角度想, 如果我们把编辑器所隐藏的部分渲染出来, 那它的高度就是渲染区的<code class="language-text">scrollTop</code>, 所以只需要获取编辑器隐藏掉的内容, 然后将其渲染到一个隐藏<code class="language-text">dom</code>中, 计算高度, 将次高度设为渲染区的<code class="language-text">scrollTop</code>, 就可以完成滚动同步</p><h4 id="代码实现" class="heading"><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" aria-hidden="true"><span class="icon icon-link"></span></a>代码实现</h4><h5 id="获取monaco-editor隐藏的行数" class="heading"><a href="#%E8%8E%B7%E5%8F%96monaco-editor%E9%9A%90%E8%97%8F%E7%9A%84%E8%A1%8C%E6%95%B0" aria-hidden="true"><span class="icon icon-link"></span></a>获取monaco-editor隐藏的行数</h5><p>由于没有找到对应api直接获取隐藏的行数, 因此用最原始的办法</p><ul><li>监听editor滚动</li><li>获取<code class="language-text">scrollHeight</code>和<code class="language-text">scrollTop</code></li><li>使用<code class="language-text">scrollTop/LINE_HEIGHT</code>粗略获取隐藏掉的行数</li></ul><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">.</span><span class="token function">onDidScrollChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>onScroll<span class="token punctuation">)</span>
<span class="token keyword">const</span> onScroll <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span>e <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> scrollHeight<span class="token punctuation">,</span> scrollTop <span class="token punctuation">}</span> <span class="token operator">=</span> e
  <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scrollHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v <span class="token operator">=</span> scrollTop <span class="token operator">/</span> <span class="token constant">LINE_HEIGHT</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onScroll</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="渲染并计算隐藏区域的高度" class="heading"><a href="#%E6%B8%B2%E6%9F%93%E5%B9%B6%E8%AE%A1%E7%AE%97%E9%9A%90%E8%97%8F%E5%8C%BA%E5%9F%9F%E7%9A%84%E9%AB%98%E5%BA%A6" aria-hidden="true"><span class="icon icon-link"></span></a>渲染并计算隐藏区域的高度</h5><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token comment">// 获取编辑器dom</span>
<span class="token keyword">function</span> <span class="token function">getDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> HTMLDivElement <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">)</span> <span class="token keyword">return</span> dom
  <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'markdown-preview'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLDivElement
<span class="token punctuation">}</span>

<span class="token keyword">let</span> _div<span class="token operator">:</span> HTMLDivElement <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token comment">// content为所有markdown内容</span>
<span class="token comment">// lineNumber为上一部获取的行数</span>
<span class="token keyword">function</span> <span class="token function">calcHeight</span><span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> lineNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据空格分行</span>
  <span class="token keyword">const</span> split <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\n]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
  <span class="token comment">// 截取前lineNumber行</span>
  <span class="token keyword">const</span> hide <span class="token operator">=</span> split<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lineNumber<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
  <span class="token comment">// 创建一个div, 并插入到body</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_div<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
    _div<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'markdown-preview'</span><span class="token punctuation">)</span>
    _div<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>_div<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 将其宽度设成跟渲染区一样宽度, 方便高度计算</span>
  _div<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">width: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clientWidth<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token comment">// 渲染内容</span>
  _div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">parseMd</span><span class="token punctuation">(</span>hide<span class="token punctuation">)</span>
  <span class="token comment">// 获取div的高度</span>
  <span class="token comment">// 此处-40是修正渲染区的paddingTop</span>
  <span class="token keyword">return</span> _div<span class="token punctuation">.</span>clientHeight <span class="token operator">-</span> <span class="token number">40</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="设置渲染区scrolltop" class="heading"><a href="#%E8%AE%BE%E7%BD%AE%E6%B8%B2%E6%9F%93%E5%8C%BAscrolltop" aria-hidden="true"><span class="icon icon-link"></span></a>设置渲染区scrollTop</h5><p>获取隐藏区的高度后即可设置对应的scrollTop</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">getDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  top
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>此时滚动已经有了较好的同步, 虽然算不上完美, 但我觉得还是一个不错的解决方案.</p><h2 id="项目打包" class="heading"><a href="#%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85" aria-hidden="true"><span class="icon icon-link"></span></a>项目打包</h2><p>使用了<a href="https://github.com/electron-userland/electron-builder">electron-builder</a>尽心打包, 只需添加<code class="language-text">electronrc.js</code>配置文件即可</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">productName</span><span class="token operator">:</span> <span class="token string">'App name'</span><span class="token punctuation">,</span> <span class="token comment">// App 名称</span>
  <span class="token literal-property property">appId</span><span class="token operator">:</span> <span class="token string">'com.App.name'</span><span class="token punctuation">,</span> <span class="token comment">// 程序的唯一标识符</span>
  <span class="token literal-property property">directories</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token string">'package'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist/**/*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 构建好的dist目录</span>
  <span class="token comment">// copyright: 'Copyright © 2019 zWing',</span>
  <span class="token literal-property property">asar</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否加密</span>
  <span class="token literal-property property">artifactName</span><span class="token operator">:</span> <span class="token string">'${productName}-${version}.${ext}'</span><span class="token punctuation">,</span>
  <span class="token comment">// compression: 'maximum', // 压缩程度</span>
  <span class="token literal-property property">dmg</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// MacOS dmg形式安装完后的界面</span>
    <span class="token literal-property property">contents</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">410</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'link'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/Applications'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">130</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'file'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mac</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'build/icons/icon.png'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">win</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'build/icons/icon.png'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'nsis'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">legalTrademarks</span><span class="token operator">:</span> <span class="token string">'Eyas Personal'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">nsis</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// windows的安装包配置</span>
    <span class="token literal-property property">allowToChangeInstallationDirectory</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">oneClick</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">menuCategory</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">allowElevation</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">linux</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'build/icons'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">electronDownload</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mirror</span><span class="token operator">:</span> <span class="token string">'http://npm.taobao.org/mirrors/electron/'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后执行<code class="language-text">electron-builder --config ./electronrc.js -mwl</code>进行打包即可, <code class="language-text">-mwl</code>指的是打包三种平台</p><p>更详细的打包配置还是去官方文档查看, 这一部分没有过多深入了解</p><h2 id="结语" class="heading"><a href="#%E7%BB%93%E8%AF%AD" aria-hidden="true"><span class="icon icon-link"></span></a>结语</h2><p>第一次开发electron应用, 还有许多地方做的不够好, 后续继续完善.</p></div><div class="comments"><div id="gitalk-container"></div></div></article></div></div></main><footer class="footer"><div class="center">Powered by <a target="_blank" href="https://github.com/acyortjs/acyort">AcyOrt</a> / Theme <a target="_blank" href="https://github.com/acyortjs/theme-donob">donob</a></div></footer><script src="/script/post.js"></script><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script>const gitalkConfig = JSON.parse('{"owner":"zWingz","repo":"my-blog-config","admin":["zWingz"],"clientID":"0438ed96c0cb944693a7","clientSecret":"23e7aa3152f5d03d8f20029540741d6f886c9f5b","number":40}')
  var gitalk = new Gitalk({
    ...gitalkConfig
  })
  gitalk.render('gitalk-container')</script><script defer="defer" src="/script/ribbon.js"></script></body></html>