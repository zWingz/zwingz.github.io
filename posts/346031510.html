<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="description" content="Just a blog."><meta name="keywords" content=""><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><title>使用Fabric+docker部署前端项目 - zWing</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6650629ba7ddbfe98e2f63700c2e6923";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><canvas id="ribbon"></canvas><main class="main"><header class="header"><a class="logo" href="/">zWing</a><nav class="menu"><a href="/archives/">Archives</a><a href="/tags/">Tags</a><a href="/about/">About</a><a href="/repo/">Repo</a></nav><div class="social"><a target="_blank" href="/rss.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18,15.64A2.18,2.18 0 0,1 8.36,17.82C8.36,19 7.38,20 6.18,20C5,20 4,19 4,17.82A2.18,2.18 0 0,1 6.18,15.64M4,4.44A15.56,15.56 0 0,1 19.56,20H16.73A12.73,12.73 0 0,0 4,7.27V4.44M4,10.1A9.9,9.9 0 0,1 13.9,20H11.07A7.07,7.07 0 0,0 4,12.93V10.1Z"></path></svg> </a><a target="_blank" href="https://github.com/zWingz/my-blog-config/issues"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"></path></svg></a></div></header><div class="content-container center"><div id="post" class="flex"><aside class="toc"><div class="stay"><ul><li><a href="#%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B">部署过程</a></li><li><a href="#%E5%88%A9%E7%94%A8docker-compose%E8%BF%90%E8%A1%8Cnode">利用docker-compose运行node</a></li><li><a href="#%E5%88%A9%E7%94%A8makefile%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4">利用makefile更好的执行命令</a></li><li><a href="#shell%E8%84%9A%E6%9C%AC-%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%89%A7%E8%A1%8Cmakefile">Shell脚本, 更好的执行makefile</a></li><li><a href="#fabric%E4%BD%BF%E7%94%A8-%E6%9B%B4%E5%BF%AB%E7%9A%84%E5%AE%8C%E6%88%90%E9%83%A8%E7%BD%B2">Fabric使用, 更快的完成部署</a><ul><li><a href="#fabric%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D">fabric基本介绍</a></li><li><a href="#%E7%94%A8%E9%80%94">用途</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">配置文件</a></li></ul></li><li><a href="#%E7%BB%93%E8%AF%AD">结语</a></li></ul><span class="toc-icon"></span></div></aside><article class="post-content"><time class="time">July 31, 2018</time><h1 class="title">使用Fabric+docker部署前端项目</h1><div><a href="/tags/1010053146" class="tags-item" style="background: #47f790;">Depoly </a><a href="/tags/819211154" class="tags-item" style="background: #92efc8;">Front End</a></div><div class="content"><h2 id="部署过程" class="heading"><a href="#%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B" aria-hidden="true"><span class="icon icon-link"></span></a>部署过程</h2><ul><li>合并<code class="language-text">develop</code>到<code class="language-text">master</code></li><li><code class="language-text">push</code>代码</li><li>远程服务器<code class="language-text">pull</code>代码</li><li>npm install(如果需要)</li><li>npm run test (如果需要)</li><li>npm run build</li></ul><h2 id="利用docker-compose运行node" class="heading"><a href="#%E5%88%A9%E7%94%A8docker-compose%E8%BF%90%E8%A1%8Cnode" aria-hidden="true"><span class="icon icon-link"></span></a>利用docker-compose运行node</h2><p>使用docker来跑<code class="language-text">node</code>, 则线上不需要有<code class="language-text">node</code>环境.</p><ul><li>将本地目录映射到<code class="language-text">docker</code>中</li><li>在<code class="language-text">docker</code>中跑<code class="language-text">npm</code>命令</li></ul><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># docker-compose.yml</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">depoly</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>container
    <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>carbon
    <span class="token key atrule">working_dir</span><span class="token punctuation">:</span> /project
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/project
</code></pre></div><p>然后编可以通过命令<code class="language-text">docker-compose run --rm deploy yarn xxx</code>来执行<code class="language-text">npm</code>命令</p><h2 id="利用makefile更好的执行命令" class="heading"><a href="#%E5%88%A9%E7%94%A8makefile%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4" aria-hidden="true"><span class="icon icon-link"></span></a>利用makefile更好的执行命令</h2><div class="gatsby-highlight" data-language="makefile"><pre class="language-makefile"><code class="language-makefile"><span class="token symbol">build</span><span class="token punctuation">:</span>
  docker-compose run --rm deploy yarn build

<span class="token symbol">install</span><span class="token punctuation">:</span>
  docker-compose run --rm deploy yarn install --production

<span class="token symbol">dev</span><span class="token punctuation">:</span>
<span class="token symbol">  docker-compose run --rm -p 8080</span><span class="token punctuation">:</span>8080 deploy yarn dev

<span class="token comment"># 因为当前build目录和build命令冲突, 用以下关键词区分两者</span>
<span class="token builtin">.PHONY</span><span class="token punctuation">:</span> build</code></pre></div><h2 id="shell脚本-更好的执行makefile" class="heading"><a href="#shell%E8%84%9A%E6%9C%AC-%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%89%A7%E8%A1%8Cmakefile" aria-hidden="true"><span class="icon icon-link"></span></a>Shell脚本, 更好的执行makefile</h2><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token function">trap</span> <span class="token string">"kill 0"</span> SIGINT

<span class="token comment"># 如果带了 -i 参数, 则需要安装依赖</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">==</span> <span class="token string">"-i"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token keyword">echo</span> -e <span class="token string">"\n\033[41;37m Install dependencies:\033[0m\n "</span>
  <span class="token function">make</span> <span class="token function">install</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$?</span>"</span> <span class="token operator">==</span> 1 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token keyword">echo</span> -e <span class="token string">"\t\033[31m Error in npm install, pleace check your package.json\n\033[0m"</span>
    <span class="token keyword">exit</span> 1
  <span class="token keyword">fi</span>
<span class="token keyword">fi</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> -e <span class="token string">"\n\n\033[41;37m Build... :\033[0m\n "</span>
<span class="token function">make</span> build
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$?</span>"</span> <span class="token operator">==</span> 1 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token keyword">echo</span> -e <span class="token string">"\t\033[31m Error in npm run build \n\033[0m"</span>
  <span class="token keyword">exit</span> 1
<span class="token keyword">else</span>
  <span class="token keyword">echo</span> -e <span class="token string">"\033[32mBuild Success \033[0m\n"</span>
<span class="token keyword">fi</span>

<span class="token keyword">exit</span> <span class="token variable">$?</span></code></pre></div><h2 id="fabric使用-更快的完成部署" class="heading"><a href="#fabric%E4%BD%BF%E7%94%A8-%E6%9B%B4%E5%BF%AB%E7%9A%84%E5%AE%8C%E6%88%90%E9%83%A8%E7%BD%B2" aria-hidden="true"><span class="icon icon-link"></span></a>Fabric使用, 更快的完成部署</h2><h3 id="fabric基本介绍" class="heading"><a href="#fabric%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D" aria-hidden="true"><span class="icon icon-link"></span></a>fabric基本介绍</h3><p><code class="language-text">fabric</code>是一个<code class="language-text">python</code>库, 可以通过<code class="language-text">ssh</code>在远程服务器执行命令.</p><p>它有两个<code class="language-text">1.0</code>和<code class="language-text">2.0</code>版本, 其中<code class="language-text">1.0</code>只支持<code class="language-text">py2</code>, <code class="language-text">2.0</code>版本可以支持<code class="language-text">py2</code>和<code class="language-text">py3</code>, 而且两个版本的<code class="language-text">api</code>区别很大, 具体请参考官方文档.</p><p>以下所使用的是<code class="language-text">fabric2.0</code>, 附上<a href="http://docs.fabfile.org/en/2.2/">fabric2.x文档</a></p><h3 id="用途" class="heading"><a href="#%E7%94%A8%E9%80%94" aria-hidden="true"><span class="icon icon-link"></span></a>用途</h3><p>可以利用它来<code class="language-text">pull</code>代码, 并执行代码编译</p><p>同时, 线上一般只拉<code class="language-text">master</code>分支, 所以<code class="language-text">fabric</code>也能帮助我们在本地合并到<code class="language-text">master</code>分支后<code class="language-text">push</code>到<code class="language-text">git</code>上</p><h3 id="配置文件" class="heading"><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" aria-hidden="true"><span class="icon icon-link"></span></a>配置文件</h3><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> fabric <span class="token keyword">import</span> Connection
<span class="token keyword">from</span> invoke <span class="token keyword">import</span> task

c <span class="token operator">=</span> Connection<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'server_name'</span><span class="token punctuation">)</span>

<span class="token comment"># 制定task</span>
<span class="token comment"># 可以通过fab depoly 调用</span>
<span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">depoly</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    c<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token string">'git checkout master'</span><span class="token punctuation">)</span> <span class="token comment"># 切换到master</span>
    c<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token string">'git rebase develop'</span><span class="token punctuation">)</span> <span class="token comment"># 合并develop分支</span>
    c<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token string">'git push origin master'</span><span class="token punctuation">)</span> <span class="token comment"># push到master</span>
    <span class="token keyword">with</span> c<span class="token punctuation">.</span>cd<span class="token punctuation">(</span><span class="token string">'/home/ubuntu/path/your_project'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        c<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'git pull'</span><span class="token punctuation">,</span> pty<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 远程拉取代码</span>
        c<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'./depoly.sh'</span><span class="token punctuation">)</span> <span class="token comment"># 远程执行build</span>
    c<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token string">'git checkout develop'</span><span class="token punctuation">)</span> <span class="token comment"># 本地切换回develop</span></code></pre></div><p>执行<code class="language-text">fab depoly</code>就可以完成一系列部署</p><h2 id="结语" class="heading"><a href="#%E7%BB%93%E8%AF%AD" aria-hidden="true"><span class="icon icon-link"></span></a>结语</h2><p>上述过程其实完全可以由各种<code class="language-text">CI</code>完成</p><p>但是对于私有<code class="language-text">gitlab</code>, 同时又没有部署<code class="language-text">gitlab-runner</code>或者不想接入第三方的话</p><p><code class="language-text">fabric</code>是个不错的选择</p></div><div class="comments"><div id="gitalk-container"></div></div></article></div></div></main><footer class="footer"><div class="center">Powered by <a target="_blank" href="https://github.com/acyortjs/acyort">AcyOrt</a> / Theme <a target="_blank" href="https://github.com/acyortjs/theme-donob">donob</a></div></footer><script src="/script/post.js"></script><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script>const gitalkConfig = JSON.parse('{"owner":"zWingz","repo":"my-blog-config","admin":["zWingz"],"clientID":"0438ed96c0cb944693a7","clientSecret":"23e7aa3152f5d03d8f20029540741d6f886c9f5b","number":18}')
  var gitalk = new Gitalk({
    ...gitalkConfig
  })
  gitalk.render('gitalk-container')</script><script defer="defer" src="/script/ribbon.js"></script></body></html>