<!doctype html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="description" content="Just a blog."><link rel="stylesheet" href="/css/style.css"><title>使用Fabric+docker部署前端项目 - zWing</title><link rel="stylesheet" href="/css/highlight.ocean.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"></head><body><canvas id="ribbon"></canvas><div class="main"><div class="header"><a class="logo" href="/">zWing</a><div class="menu"><a href="/archives/">Archives</a><a href="/about/">About</a></div><div class="social"><a target="_blank" href="https://github.com/zWingz/my-blog-config/issues"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"></path></svg></a><a target="_blank" href="/rss.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18,15.64A2.18,2.18 0 0,1 8.36,17.82C8.36,19 7.38,20 6.18,20C5,20 4,19 4,17.82A2.18,2.18 0 0,1 6.18,15.64M4,4.44A15.56,15.56 0 0,1 19.56,20H16.73A12.73,12.73 0 0,0 4,7.27V4.44M4,10.1A9.9,9.9 0 0,1 13.9,20H11.07A7.07,7.07 0 0,0 4,12.93V10.1Z"></path></svg></a></div></div><div id="post" class="center"><div class="toc"><div class="stay"><ul><li><a href="#%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B">部署过程</a></li><li><a href="#docker%E9%85%8D%E7%BD%AE-%E4%BD%BF%E7%94%A8dockernode%E5%AE%8C%E6%88%90%E7%BC%96%E8%AF%91">Docker配置, 使用docker+node完成编译</a><ul><li><a href="#%E4%BD%BF%E7%94%A8docker%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96">使用docker安装依赖</a></li></ul></li><li><a href="#shell%E8%84%9A%E6%9C%AC-%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%89%A7%E8%A1%8Cdocker">Shell脚本, 更好的执行docker</a></li><li><a href="#fabric%E4%BD%BF%E7%94%A8-%E6%9B%B4%E5%BF%AB%E7%9A%84%E5%AE%8C%E6%88%90%E9%83%A8%E7%BD%B2">Fabric使用, 更快的完成部署</a><ul><li><a href="#fabric%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D">fabric基本介绍</a></li><li><a href="#%E7%94%A8%E9%80%94">用途</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">配置文件</a></li></ul></li><li><a href="#%E7%BB%93%E8%AF%AD">结语</a></li></ul><span class="toc-icon"></span></div></div><div class="post-content"><p class="time">July 31, 2018</p><h1 class="title">使用Fabric+docker部署前端项目</h1><div class="content"><h2 id="%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B" class="heading"><a href="#%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B" class="heading-anchor"></a>部署过程</h2><ul><li>合并<code>develop</code>到<code>master</code></li><li><code>push</code>代码</li><li>远程服务器<code>pull</code>代码</li><li>npm install(如果需要)</li><li>npm run test (如果需要)</li><li>npm run build</li></ul><h2 id="docker%E9%85%8D%E7%BD%AE-%E4%BD%BF%E7%94%A8dockernode%E5%AE%8C%E6%88%90%E7%BC%96%E8%AF%91" class="heading"><a href="#docker%E9%85%8D%E7%BD%AE-%E4%BD%BF%E7%94%A8dockernode%E5%AE%8C%E6%88%90%E7%BC%96%E8%AF%91" class="heading-anchor"></a>Docker配置, 使用docker+node完成编译</h2><p>使用docker来部署, 则线上不需要有<code>node</code>环境.</p><h3 id="%E4%BD%BF%E7%94%A8docker%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96" class="heading"><a href="#%E4%BD%BF%E7%94%A8docker%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96" class="heading-anchor"></a>使用docker安装依赖</h3><ul><li>将本地目录映射到<code>docker</code>中</li><li>在<code>docker</code>中跑<code>npm</code>命令</li></ul><div class="hljs docker"><table><tbody><tr><td class="line"><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
</pre></td><td class="code"><pre><span class="hljs-meta"># docker-compose.yml</span>
<span class="hljs-symbol">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-symbol">services:</span>
<span class="hljs-symbol">  depoly:</span>
<span class="hljs-symbol">    container_name:</span> project-container
<span class="hljs-symbol">    image:</span> node:carbon
<span class="hljs-symbol">    working_dir:</span> /project
<span class="hljs-symbol">    volumes:</span>
        - .:/project</pre></td></tr></tbody></table></div><h2 id="shell%E8%84%9A%E6%9C%AC-%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%89%A7%E8%A1%8Cdocker" class="heading"><a href="#shell%E8%84%9A%E6%9C%AC-%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%89%A7%E8%A1%8Cdocker" class="heading-anchor"></a>Shell脚本, 更好的执行docker</h2><div class="hljs bash"><table><tbody><tr><td class="line"><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
</pre></td><td class="code"><pre><span class="hljs-comment">#!/bin/bash</span>

<span class="hljs-comment"># 判断最近一次提交是否修改过package-lock, 以及node_modules是否为空</span>
<span class="hljs-comment"># 如果是, 则重新执行npm install</span>
package=$(git diff --name-only HEAD~ HEAD | grep <span class="hljs-string">"package-lock.json"</span>)

<span class="hljs-keyword">if</span> [ ! -d <span class="hljs-string">"./node_modules"</span> -o -n <span class="hljs-string">"$package"</span> ]; then
  echo -e <span class="hljs-string">"\n\033[41;37m Install dependence:\033[0m\n "</span>
  <span class="hljs-comment"># 跑docker命令</span>
  docker-compose run --rm depoly npm install
  <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"$?"</span> == <span class="hljs-number">1</span> ]]; then
    echo -e <span class="hljs-string">"\t\033[31m Error in npm install, pleace check your package.json\n\033[0m"</span>
    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
  fi
fi;

<span class="hljs-comment"># 执行编译</span>
echo -e <span class="hljs-string">"\n\n\033[41;37m Build... :\033[0m\n "</span>

<span class="hljs-comment"># 跑docker命令</span>
docker-compose run --rm depoly npm run build
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">"$?"</span> == <span class="hljs-number">1</span> ]]; then
  echo -e <span class="hljs-string">"\t\033[31m Error in npm run build \n\033[0m"</span>
  <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">else</span>
  echo -e <span class="hljs-string">"\033[32mBuild Success \033[0m\n"</span>
fi

<span class="hljs-keyword">exit</span> $?</pre></td></tr></tbody></table></div><h2 id="fabric%E4%BD%BF%E7%94%A8-%E6%9B%B4%E5%BF%AB%E7%9A%84%E5%AE%8C%E6%88%90%E9%83%A8%E7%BD%B2" class="heading"><a href="#fabric%E4%BD%BF%E7%94%A8-%E6%9B%B4%E5%BF%AB%E7%9A%84%E5%AE%8C%E6%88%90%E9%83%A8%E7%BD%B2" class="heading-anchor"></a>Fabric使用, 更快的完成部署</h2><h3 id="fabric%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D" class="heading"><a href="#fabric%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D" class="heading-anchor"></a>fabric基本介绍</h3><p><code>fabric</code>是一个<code>python</code>库, 可以通过<code>ssh</code>在远程服务器执行命令.</p><p>它有两个<code>1.0</code>和<code>2.0</code>版本, 其中<code>1.0</code>只支持<code>py2</code>, <code>2.0</code>版本可以支持<code>py2</code>和<code>py3</code>, 而且两个版本的<code>api</code>区别很大, 具体请参考官方文档.</p><p>以下所使用的是<code>fabric2.0</code>, 附上<a href="http://docs.fabfile.org/en/2.2/">fabric2.x文档</a></p><h3 id="%E7%94%A8%E9%80%94" class="heading"><a href="#%E7%94%A8%E9%80%94" class="heading-anchor"></a>用途</h3><p>可以利用它来<code>pull</code>代码, 并执行代码编译</p><p>同时, 线上一般只拉<code>master</code>分支, 所以<code>fabric</code>也能帮助我们在本地合并到<code>master</code>分支后<code>push</code>到<code>git</code>上</p><h3 id="%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" class="heading"><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" class="heading-anchor"></a>配置文件</h3><div class="hljs python"><table><tbody><tr><td class="line"><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
</pre></td><td class="code"><pre><span class="hljs-keyword">from</span> fabric <span class="hljs-keyword">import</span> Connection
<span class="hljs-keyword">from</span> invoke <span class="hljs-keyword">import</span> task

c = Connection(host=<span class="hljs-string">'server_name'</span>)

<span class="hljs-comment"># 制定task</span>
<span class="hljs-comment"># 可以通过fab depoly 调用</span>
<span class="hljs-meta">@task</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">depoly</span><span class="hljs-params">(d)</span>:</span>
    c.local(<span class="hljs-string">'git checkout master'</span>) <span class="hljs-comment"># 切换到master</span>
    c.local(<span class="hljs-string">'git rebase develop'</span>) <span class="hljs-comment"># 合并develop分支</span>
    c.local(<span class="hljs-string">'git push origin master'</span>) <span class="hljs-comment"># push到master</span>
    <span class="hljs-keyword">with</span> c.cd(<span class="hljs-string">'/home/ubuntu/path/your_project'</span>):
        c.run(<span class="hljs-string">'git pull'</span>, pty=<span class="hljs-keyword">True</span>) <span class="hljs-comment"># 远程拉取代码</span>
        c.run(<span class="hljs-string">'./depoly.sh'</span>) <span class="hljs-comment"># 远程执行build</span>
    c.local(<span class="hljs-string">'git checkout develop'</span>) <span class="hljs-comment"># 本地切换回develop</span>
</pre></td></tr></tbody></table></div><p>执行<code>fab depoly</code>就可以完成一系列部署</p><h2 id="%E7%BB%93%E8%AF%AD" class="heading"><a href="#%E7%BB%93%E8%AF%AD" class="heading-anchor"></a>结语</h2><p>上述过程其实完全可以由各种<code>CI</code>完成</p><p>但是对于私有<code>gitlab</code>, 同时又没有部署<code>gitlab-runner</code>或者不想接入第三方的话</p><p><code>fabric</code>是个不错的选择</p></div><div class="comments"><div id="gitalk-container"></div></div></div></div></div><div class="footer"><div class="center">zWing / Powered by <a target="_blank" href="https://github.com/acyortjs/acyort">AcyOrt</a> / Theme <a target="_blank" href="https://github.com/acyortjs/theme-donob">donob</a></div></div><script src="/script/post.js"></script><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script>const gitalkConfig = JSON.parse('{"owner":"zWingz","repo":"my-blog-config","admin":["zWingz"],"clientID":"0438ed96c0cb944693a7","clientSecret":"23e7aa3152f5d03d8f20029540741d6f886c9f5b","number":18}')
  var gitalk = new Gitalk({
    ...gitalkConfig
  })
  gitalk.render('gitalk-container')</script><script defer="defer" src="/script/ribbon.js"></script></body></html>